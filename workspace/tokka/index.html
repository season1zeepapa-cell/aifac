<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TOKKA - ì±„íŒ…</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #FFB6C1; border-radius: 2px; }

    /* í† ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes slideUp {
      from { transform: translateX(-50%) translateY(100%); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    @keyframes slideDown {
      from { transform: translateX(-50%) translateY(0); opacity: 1; }
      to { transform: translateX(-50%) translateY(100%); opacity: 0; }
    }
    .toast-enter { animation: slideUp 0.3s ease-out forwards; }
    .toast-exit { animation: slideDown 0.3s ease-in forwards; }

    /* í˜ì´ë“œì¸ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.2s ease-out; }

    /* ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ */
    @keyframes overlayIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .overlay-in { animation: overlayIn 0.2s ease-out; }

    /* ë°”í…€ì‹œíŠ¸ */
    @keyframes sheetUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    .sheet-up { animation: sheetUp 0.3s ease-out; }

    /* ì…ë ¥ í¬ì»¤ìŠ¤ ì‹œ ì™¸ê³½ì„  í•‘í¬ */
    input:focus, textarea:focus {
      outline: none;
      border-color: #FF6B9D !important;
      box-shadow: 0 0 0 2px rgba(255, 107, 157, 0.2);
    }

    /* ê¸°ë³¸ body ì„¸íŒ… */
    body {
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    html.dark body {
      background: #0d0f12;
    }

    /* ìŠ¤í”Œë˜ì‹œ íš¨ê³¼ ë°©ì§€ */
    * { -webkit-tap-highlight-color: transparent; }

    /* í…Œë§ˆ ë§ (ì•„ë°”íƒ€ í…Œë‘ë¦¬) */
    .theme-ring {
      box-shadow: 0 0 0 2.5px white, 0 0 0 4.5px var(--theme-main);
    }
    .dark .theme-ring {
      box-shadow: 0 0 0 2.5px rgb(30 33 40), 0 0 0 4.5px var(--theme-main);
    }

    /* ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ ì™¼ìª½ í…Œë§ˆ ë°” */
    .theme-card {
      border-left: 3.5px solid var(--theme-main);
      background: white;
    }

    /* íƒ­ë°” í™œì„± ì¸ë””ì¼€ì´í„° */
    .tab-active-bar {
      background: linear-gradient(90deg, var(--theme-main), var(--theme-dark));
    }

    /* ì•± ë°°ê²½ - ì—°í•œ ê·¸ë¼ë°ì´ì…˜ */
    .app-bg {
      background: linear-gradient(180deg,
        var(--theme-soft) 0%,
        #f5f6f8 35%,
        #f0f2f5 100%
      );
    }
    .dark .app-bg {
      background: linear-gradient(180deg,
        var(--theme-soft-dark) 0%,
        #15171c 40%,
        #0d0f12 100%
      );
    }

    /* ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ ë‹¤í¬ëª¨ë“œ */
    .dark .theme-card {
      background: rgba(30, 33, 40, 0.9);
      border-left-color: var(--theme-main);
    }

    /* â”€â”€â”€ í…Œë§ˆ CSS ë³€ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --theme-main: #FF6B9D;
      --theme-dark: #E91E8C;
      --theme-light: #FFE4EE;
    }

    /* Tailwind ì»¤ìŠ¤í…€ pink-* í´ë˜ìŠ¤ë¥¼ CSS ë³€ìˆ˜ë¡œ ì˜¤ë²„ë¼ì´ë“œ */
    .bg-pink-main   { background-color: var(--theme-main) !important; }
    .bg-pink-dark   { background-color: var(--theme-dark) !important; }
    .bg-pink-light  { background-color: var(--theme-light) !important; }
    .text-pink-main { color: var(--theme-main) !important; }
    .border-pink-main { border-color: var(--theme-main) !important; }
    .border-t-pink-main { border-top-color: var(--theme-main) !important; }
    .hover\:bg-pink-dark:hover { background-color: var(--theme-dark) !important; }
    .hover\:bg-pink-light:hover { background-color: var(--theme-light) !important; }
    .hover\:text-pink-dark:hover { color: var(--theme-dark) !important; }
    .active\:bg-pink-dark:active { background-color: var(--theme-dark) !important; }
    .from-pink-main {
      --tw-gradient-from: var(--theme-main) !important;
      --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(0,0,0,0)) !important;
    }
    .to-pink-dark { --tw-gradient-to: var(--theme-dark) !important; }

    /* ìŠ¤í¬ë¡¤ë°” */
    ::-webkit-scrollbar-thumb { background: var(--theme-light) !important; }

    /* ì…ë ¥ í¬ì»¤ìŠ¤ */
    input:focus, textarea:focus {
      border-color: var(--theme-main) !important;
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--theme-main) 20%, transparent) !important;
    }
  </style>
  <script>
    // Tailwind ì»¤ìŠ¤í…€ ì„¤ì •
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            pink: {
              main: '#FF6B9D',
              dark: '#E91E8C',
              light: '#FFE4EE',
              bubble: '#FF6B9D',
            }
          }
        }
      }
    }
  </script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    // ========================================
    // React í›… ë””ìŠ¤íŠ¸ëŸ­ì²˜ë§
    // ========================================
    const {
      useState, useEffect, useRef, useCallback,
      useMemo, useContext, createContext, useReducer
    } = React;

    // ========================================
    // ìƒìˆ˜ ë° ì„¤ì •
    // ========================================
    const API_BASE_URL = window.location.origin + '/api';

    // ========================================
    // í…Œë§ˆ ì •ì˜
    // ========================================
    const THEMES = [
      { id: 'pink',     label: 'í•‘í¬',   emoji: 'ğŸŒ¸', main: '#FF6B9D', dark: '#E91E8C', light: '#FFE4EE' },
      { id: 'kakao',    label: 'ì¹´ì¹´ì˜¤', emoji: 'ğŸ’›', main: '#E5A500', dark: '#C78B00', light: '#FFF8DC' },
      { id: 'ocean',    label: 'ì˜¤ì…˜',   emoji: 'ğŸŒŠ', main: '#0EA5E9', dark: '#0284C7', light: '#E0F2FE' },
      { id: 'mint',     label: 'ë¯¼íŠ¸',   emoji: 'ğŸŒ¿', main: '#059669', dark: '#047857', light: '#D1FAE5' },
      { id: 'lavender', label: 'ë¼ë²¤ë”', emoji: 'ğŸ’œ', main: '#7C3AED', dark: '#5B21B6', light: '#EDE9FE' },
      { id: 'coral',    label: 'ì½”ë„',   emoji: 'ğŸª¸', main: '#F97316', dark: '#EA580C', light: '#FFF7ED' },
    ];

    // hex â†’ rgba ìœ í‹¸
    function hexToRgba(hex, alpha) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r},${g},${b},${alpha})`;
    }

    function applyTheme(themeId) {
      const theme = THEMES.find(t => t.id === themeId) || THEMES[0];
      const root = document.documentElement;
      root.style.setProperty('--theme-main', theme.main);
      root.style.setProperty('--theme-dark', theme.dark);
      root.style.setProperty('--theme-light', theme.light);
      root.style.setProperty('--theme-soft', hexToRgba(theme.light || theme.main, 0.35));
      root.style.setProperty('--theme-soft-dark', hexToRgba(theme.main, 0.1));
      localStorage.setItem('tokka_theme', themeId);
    }

    function applyDarkMode(isDark) {
      document.documentElement.classList.toggle('dark', isDark);
      localStorage.setItem('tokka_dark', isDark ? '1' : '0');
    }

    // ì•± ì‹œì‘ ì‹œ ì €ì¥ëœ í…Œë§ˆ/ë‹¤í¬ëª¨ë“œ ì¦‰ì‹œ ì ìš©
    applyTheme(localStorage.getItem('tokka_theme') || 'pink');
    applyDarkMode(localStorage.getItem('tokka_dark') === '1');

    const SUPABASE_URL = 'https://amhcwpehfuzuckuicaeb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtaGN3cGVoZnV6dWNrdWljYWViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MzEwNjYsImV4cCI6MjA4NzQwNzA2Nn0.l4E8pYf2zMfHr7aYAU7FWSsesmeMQGBpCQG4vN4QP18';

    // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ========================================
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // ========================================

    // JWT í† í° ê´€ë¦¬
    function getToken() {
      return localStorage.getItem('tokka_token');
    }
    function setToken(token) {
      localStorage.setItem('tokka_token', token);
    }
    function removeToken() {
      localStorage.removeItem('tokka_token');
    }

    // ì¸ì¦ í—¤ë” í¬í•¨ fetch ë˜í¼
    async function apiFetch(endpoint, options = {}) {
      const token = getToken();
      const headers = {
        ...(options.headers || {}),
      };
      // FormDataê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ Content-Type ì„¤ì •
      if (!(options.body instanceof FormData)) {
        headers['Content-Type'] = 'application/json';
      }
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      const res = await fetch(`${API_BASE_URL}${endpoint}`, {
        ...options,
        headers,
      });
      if (res.status === 401) {
        removeToken();
        window.location.hash = '#login';
        throw new Error('ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
      }
      const json = await res.json();
      if (!res.ok) {
        throw new Error(json.error || json.message || 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
      // ì„œë²„ ì‘ë‹µ í˜•ì‹: { success, data, message } â†’ dataë§Œ ë°˜í™˜
      return json.data !== undefined ? json.data : json;
    }

    // ì´ë¯¸ì§€ ì••ì¶• ìœ í‹¸ë¦¬í‹° (Canvas API ê¸°ë°˜)
    function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.8) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const objectUrl = URL.createObjectURL(file);
        img.onload = () => {
          URL.revokeObjectURL(objectUrl);
          let { width, height } = img;
          if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            width = Math.round(width * ratio);
            height = Math.round(height * ratio);
          }
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          canvas.toBlob(
            (blob) => blob ? resolve(blob) : reject(new Error('ì´ë¯¸ì§€ ì••ì¶•ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')),
            'image/jpeg',
            quality
          );
        };
        img.onerror = () => {
          URL.revokeObjectURL(objectUrl);
          reject(new Error('ì´ë¯¸ì§€ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
        };
        img.src = objectUrl;
      });
    }

    // ì‹œê°„ í¬ë§· (ì¹´ì¹´ì˜¤í†¡ ìŠ¤íƒ€ì¼)
    function formatTime(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMin = Math.floor(diffMs / 60000);
      const diffHour = Math.floor(diffMs / 3600000);

      // 1ë¶„ ì´ë‚´
      if (diffMin < 1) return 'ë°©ê¸ˆ ì „';
      // 60ë¶„ ì´ë‚´
      if (diffMin < 60) return `${diffMin}ë¶„ ì „`;

      // ì˜¤ëŠ˜
      const isToday = date.toDateString() === now.toDateString();
      if (isToday) {
        const h = date.getHours();
        const m = String(date.getMinutes()).padStart(2, '0');
        const ampm = h < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
        const hour12 = h % 12 || 12;
        return `${ampm} ${hour12}:${m}`;
      }

      // ì–´ì œ
      const yesterday = new Date(now);
      yesterday.setDate(yesterday.getDate() - 1);
      if (date.toDateString() === yesterday.toDateString()) return 'ì–´ì œ';

      // ì˜¬í•´
      if (date.getFullYear() === now.getFullYear()) {
        return `${date.getMonth() + 1}/${date.getDate()}`;
      }

      // ê·¸ ì™¸
      return `${date.getFullYear()}.${date.getMonth() + 1}.${date.getDate()}`;
    }

    // ë©”ì‹œì§€ ì‹œê°„ (ì±„íŒ…ë°© ë‚´ë¶€ìš© - ì˜¤ì „/ì˜¤í›„ HH:MM)
    function formatMessageTime(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const h = date.getHours();
      const m = String(date.getMinutes()).padStart(2, '0');
      const ampm = h < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
      const hour12 = h % 12 || 12;
      return `${ampm} ${hour12}:${m}`;
    }

    // ë‚ ì§œ êµ¬ë¶„ì„ ìš© í¬ë§·
    function formatDateDivider(dateStr) {
      const date = new Date(dateStr);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      const weekday = weekdays[date.getDay()];
      return `${year}ë…„ ${month}ì›” ${day}ì¼ ${weekday}ìš”ì¼`;
    }

    // ê°™ì€ ë‚ ì¸ì§€ í™•ì¸
    function isSameDay(d1, d2) {
      if (!d1 || !d2) return false;
      const a = new Date(d1);
      const b = new Date(d2);
      return a.toDateString() === b.toDateString();
    }

    // ========================================
    // ì „ì—­ ìƒíƒœ Context
    // ========================================
    const AppContext = createContext(null);

    function AppProvider({ children }) {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [toasts, setToasts] = useState([]);

      // í† ìŠ¤íŠ¸ ì•Œë¦¼
      const showToast = useCallback((message, type = 'info') => {
        const id = Date.now() + Math.random();
        setToasts(prev => [...prev, { id, message, type, exiting: false }]);
        setTimeout(() => {
          setToasts(prev => prev.map(t => t.id === id ? { ...t, exiting: true } : t));
          setTimeout(() => {
            setToasts(prev => prev.filter(t => t.id !== id));
          }, 300);
        }, 2500);
      }, []);

      // ì´ˆê¸° ì¸ì¦ í™•ì¸
      useEffect(() => {
        const token = getToken();
        if (token) {
          apiFetch('/auth/me')
            .then(data => {
              setUser(data.user || data);
              setLoading(false);
            })
            .catch(() => {
              removeToken();
              setLoading(false);
            });
        } else {
          setLoading(false);
        }
      }, []);

      const login = useCallback(async (email, password) => {
        const data = await apiFetch('/auth/login', {
          method: 'POST',
          body: JSON.stringify({ email, password }),
        });
        setToken(data.token);
        setUser(data.user);
        return data;
      }, []);

      const register = useCallback(async (email, password, nickname) => {
        const data = await apiFetch('/auth/register', {
          method: 'POST',
          body: JSON.stringify({ email, password, nickname }),
        });
        return data;
      }, []);

      const logout = useCallback(() => {
        removeToken();
        setUser(null);
        window.location.hash = '#login';
      }, []);

      const updateUser = useCallback((updates) => {
        setUser(prev => prev ? { ...prev, ...updates } : prev);
      }, []);

      const value = useMemo(() => ({
        user, setUser, loading, login, register, logout, updateUser,
        toasts, showToast,
      }), [user, loading, login, register, logout, updateUser, toasts, showToast]);

      return (
        <AppContext.Provider value={value}>
          {children}
        </AppContext.Provider>
      );
    }

    function useApp() {
      return useContext(AppContext);
    }

    // ========================================
    // ë¼ìš°í„°
    // ========================================
    const RouterContext = createContext({ path: '', params: {}, navigate: () => {} });

    function useRouter() {
      return useContext(RouterContext);
    }

    // ë©”ì¸ íƒ­ ìˆœì„œ (ìŠ¤ì™€ì´í”„ ë„¤ë¹„ê²Œì´ì…˜ìš©)
    const TAB_ORDER = ['friends', 'chats', 'settings'];

    // ìŠ¤ì™€ì´í”„ ê°ì§€ í›… (í„°ì¹˜ ì œìŠ¤ì²˜ë¡œ í˜ì´ì§€ ì „í™˜)
    function useSwipe(onSwipeLeft, onSwipeRight) {
      const touchStartX = useRef(0);
      const touchStartY = useRef(0);
      const touchEndX = useRef(0);
      const touchEndY = useRef(0);
      const isSwiping = useRef(false);

      const handleTouchStart = useCallback((e) => {
        touchStartX.current = e.touches[0].clientX;
        touchStartY.current = e.touches[0].clientY;
        touchEndX.current = e.touches[0].clientX;
        touchEndY.current = e.touches[0].clientY;
        isSwiping.current = true;
      }, []);

      const handleTouchMove = useCallback((e) => {
        if (!isSwiping.current) return;
        touchEndX.current = e.touches[0].clientX;
        touchEndY.current = e.touches[0].clientY;
      }, []);

      const handleTouchEnd = useCallback(() => {
        if (!isSwiping.current) return;
        isSwiping.current = false;

        const diffX = touchStartX.current - touchEndX.current;
        const diffY = touchStartY.current - touchEndY.current;
        const threshold = 50;

        // Yì¶• ì´ë™ì´ Xì¶•ë³´ë‹¤ í¬ë©´ ìŠ¤í¬ë¡¤ë¡œ íŒë‹¨ (ìŠ¤ì™€ì´í”„ ë¬´ì‹œ)
        if (Math.abs(diffY) > Math.abs(diffX)) return;

        if (Math.abs(diffX) > threshold) {
          if (diffX > 0) onSwipeLeft?.();  // ì™¼ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ â†’ ë‹¤ìŒ íƒ­
          else onSwipeRight?.();           // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ â†’ ì´ì „ íƒ­
        }
      }, [onSwipeLeft, onSwipeRight]);

      return { handleTouchStart, handleTouchMove, handleTouchEnd };
    }

    // ê²½ë¡œ ë§¤ì¹­ (ë™ì  íŒŒë¼ë¯¸í„° ì§€ì›)
    function matchRoute(pattern, path) {
      const patternParts = pattern.split('/').filter(Boolean);
      const pathParts = path.split('/').filter(Boolean);

      if (patternParts.length !== pathParts.length) return null;

      const params = {};
      for (let i = 0; i < patternParts.length; i++) {
        if (patternParts[i].startsWith(':')) {
          params[patternParts[i].slice(1)] = pathParts[i];
        } else if (patternParts[i] !== pathParts[i]) {
          return null;
        }
      }
      return params;
    }

    function Router({ children }) {
      const [hash, setHash] = useState(window.location.hash.slice(1) || 'login');

      useEffect(() => {
        const handleHash = () => {
          setHash(window.location.hash.slice(1) || 'login');
        };
        window.addEventListener('hashchange', handleHash);
        return () => window.removeEventListener('hashchange', handleHash);
      }, []);

      const navigate = useCallback((path) => {
        window.location.hash = '#' + path;
      }, []);

      const value = useMemo(() => ({ path: hash, navigate }), [hash, navigate]);

      return (
        <RouterContext.Provider value={value}>
          {children}
        </RouterContext.Provider>
      );
    }

    // ========================================
    // ë””ìì¸ ì‹œìŠ¤í…œ ì»´í¬ë„ŒíŠ¸
    // ========================================

    // ì•„ë°”íƒ€ (í”„ë¡œí•„ ì´ë¯¸ì§€ or ì´ë‹ˆì…œ)
    function Avatar({ src, name, size = 'md', className = '', onClick, fit = 'cover' }) {
      const sizeMap = {
        xs: 'w-8 h-8 text-xs',
        sm: 'w-10 h-10 text-sm',
        md: 'w-12 h-12 text-base',
        lg: 'w-16 h-16 text-lg',
        xl: 'w-20 h-20 text-xl',
        '2xl': 'w-28 h-28 text-3xl',
        '3xl': 'w-36 h-36 text-4xl',
      };

      const initial = (name || '?').charAt(0).toUpperCase();
      const objectFit = fit === 'contain' ? 'object-contain' : 'object-cover';

      if (src) {
        return (
          <img
            src={src}
            alt={name || 'í”„ë¡œí•„'}
            className={`${sizeMap[size] || sizeMap.md} rounded-full flex-shrink-0 bg-gray-100 ${className}`}
            style={{ objectFit, ...(onClick ? { cursor: 'pointer' } : {}) }}
            onClick={onClick}
          />
        );
      }

      return (
        <div
          className={`${sizeMap[size]} rounded-full bg-pink-main text-white flex items-center justify-center font-bold flex-shrink-0 ${className}`}
          onClick={onClick}
          style={onClick ? { cursor: 'pointer' } : {}}
        >
          {initial}
        </div>
      );
    }

    // ë²„íŠ¼
    function Button({ children, variant = 'primary', size = 'md', disabled, onClick, className = '', type = 'button' }) {
      const base = 'font-semibold rounded-xl transition-all duration-200 flex items-center justify-center';
      const variants = {
        primary: 'bg-pink-main text-white hover:bg-pink-dark active:scale-[0.97]',
        secondary: 'bg-gray-100 text-gray-700 hover:bg-gray-200 active:scale-[0.97]',
        danger: 'bg-red-500 text-white hover:bg-red-600 active:scale-[0.97]',
        ghost: 'bg-transparent text-gray-600 hover:bg-gray-100',
        outline: 'border-2 border-pink-main text-pink-main hover:bg-pink-light',
      };
      const sizes = {
        sm: 'px-3 py-1.5 text-sm',
        md: 'px-5 py-2.5 text-base',
        lg: 'px-6 py-3 text-lg',
        full: 'w-full px-5 py-3 text-base',
      };

      return (
        <button
          type={type}
          onClick={onClick}
          disabled={disabled}
          className={`${base} ${variants[variant]} ${sizes[size]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`}
        >
          {children}
        </button>
      );
    }

    // í…ìŠ¤íŠ¸ ì…ë ¥
    function Input({ label, type = 'text', value, onChange, placeholder, error, disabled, className = '', autoFocus }) {
      return (
        <div className={`w-full ${className}`}>
          {label && <label className="block text-sm font-medium text-gray-700 mb-1.5">{label}</label>}
          <input
            type={type}
            value={value}
            onChange={onChange}
            placeholder={placeholder}
            disabled={disabled}
            autoFocus={autoFocus}
            className={`w-full px-4 py-3 rounded-xl border ${
              error ? 'border-red-400' : 'border-gray-200'
            } bg-white text-gray-900 placeholder-gray-400 transition-colors ${
              disabled ? 'opacity-50 cursor-not-allowed bg-gray-50' : ''
            }`}
          />
          {error && <p className="mt-1 text-sm text-red-500">{error}</p>}
        </div>
      );
    }

    // ëª¨ë‹¬ (ë°”í…€ì‹œíŠ¸ ìŠ¤íƒ€ì¼)
    function Modal({ isOpen, onClose, title, children, size = 'md' }) {
      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-50 flex items-end justify-center overlay-in" onClick={onClose}>
          <div className="absolute inset-0 bg-black/40" />
          <div
            className={`relative bg-white rounded-t-2xl w-full max-w-[420px] sheet-up max-h-[85vh] overflow-y-auto`}
            onClick={e => e.stopPropagation()}
          >
            {/* í•¸ë“¤ ë°” */}
            <div className="flex justify-center pt-3 pb-1">
              <div className="w-10 h-1 bg-gray-300 rounded-full" />
            </div>
            {title && (
              <div className="px-5 py-3 border-b border-gray-100">
                <h3 className="text-lg font-bold text-gray-900">{title}</h3>
              </div>
            )}
            <div className="px-5 py-4">
              {children}
            </div>
          </div>
        </div>
      );
    }

    // í’€ìŠ¤í¬ë¦° ëª¨ë‹¬
    function FullModal({ isOpen, onClose, title, children, rightAction }) {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 z-50 bg-white flex flex-col max-w-[420px] mx-auto shadow-2xl fade-in">
          <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100">
            <button onClick={onClose} className="p-1 text-gray-600 hover:text-gray-900">
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
            <h3 className="text-lg font-bold text-gray-900">{title}</h3>
            <div className="w-8">{rightAction || null}</div>
          </div>
          <div className="flex-1 overflow-y-auto">
            {children}
          </div>
        </div>
      );
    }

    // í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ
    function ToastContainer() {
      const { toasts } = useApp();
      return (
        <div className="fixed bottom-24 left-1/2 z-[100] flex flex-col gap-2 pointer-events-none">
          {toasts.map(toast => (
            <div
              key={toast.id}
              className={`${toast.exiting ? 'toast-exit' : 'toast-enter'} px-5 py-3 rounded-xl shadow-lg text-sm font-medium whitespace-nowrap ${
                toast.type === 'error' ? 'bg-red-500 text-white' :
                toast.type === 'success' ? 'bg-green-500 text-white' :
                'bg-gray-800 text-white'
              }`}
              style={{ position: 'relative', left: '-50%' }}
            >
              {toast.message}
            </div>
          ))}
        </div>
      );
    }

    // ë¡œë”© ìŠ¤í”¼ë„ˆ
    function Spinner({ size = 'md', className = '' }) {
      const sizeMap = { sm: 'w-5 h-5', md: 'w-8 h-8', lg: 'w-12 h-12' };
      return (
        <div className={`flex items-center justify-center ${className}`}>
          <div className={`${sizeMap[size]} border-3 border-pink-light border-t-pink-main rounded-full animate-spin`}
            style={{ borderWidth: '3px' }} />
        </div>
      );
    }

    // ë¹ˆ ìƒíƒœ
    function EmptyState({ icon, title, description, action }) {
      return (
        <div className="flex flex-col items-center justify-center py-16 px-8 text-center">
          {icon && <div className="text-5xl mb-4">{icon}</div>}
          <p className="text-gray-500 dark:text-gray-400 font-medium text-lg">{title}</p>
          {description && <p className="text-gray-400 dark:text-gray-500 text-sm mt-2">{description}</p>}
          {action && <div className="mt-5">{action}</div>}
        </div>
      );
    }

    // íƒ­ ë°” ì•„ì´ì½˜ (SVG)
    function TabIcon({ name, active }) {
      const color = active ? '#FF6B9D' : '#9CA3AF';
      switch (name) {
        case 'friends':
          return (
            <svg className="w-6 h-6" fill={color} viewBox="0 0 24 24">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
            </svg>
          );
        case 'chats':
          return (
            <svg className="w-6 h-6" fill={color} viewBox="0 0 24 24">
              <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" />
            </svg>
          );
        case 'settings':
          return (
            <svg className="w-6 h-6" fill={color} viewBox="0 0 24 24">
              <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.49.49 0 00-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
            </svg>
          );
        default:
          return null;
      }
    }

    // ========================================
    // ê³µí†µ/ë ˆì´ì•„ì›ƒ ì»´í¬ë„ŒíŠ¸
    // ========================================

    // í•˜ë‹¨ íƒ­ ë„¤ë¹„ê²Œì´ì…˜
    function BottomTabBar() {
      const { path, navigate } = useRouter();
      const [showSwipeHint, setShowSwipeHint] = useState(() => {
        return !localStorage.getItem('tokka_swipe_hint_seen');
      });

      // ìŠ¤ì™€ì´í”„ íŒíŠ¸ ìˆ¨ê¸°ê¸° (3ì´ˆ í›„ ë˜ëŠ” íƒ­ ì´ë™ ì‹œ)
      useEffect(() => {
        if (showSwipeHint) {
          const timer = setTimeout(() => {
            setShowSwipeHint(false);
            localStorage.setItem('tokka_swipe_hint_seen', '1');
          }, 4000);
          return () => clearTimeout(timer);
        }
      }, [showSwipeHint]);

      const tabs = [
        { key: 'friends', label: 'ì¹œêµ¬', icon: 'friends' },
        { key: 'chats', label: 'ì±„íŒ…', icon: 'chats' },
        { key: 'settings', label: 'ì„¤ì •', icon: 'settings' },
      ];

      const currentIndex = tabs.findIndex(t => t.key === path || (t.key === 'friends' && path === ''));

      return (
        <div className="bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-700 safe-area-bottom">
          {/* í˜ì´ì§€ ì¸ë””ì¼€ì´í„° ë„íŠ¸ + ìŠ¤ì™€ì´í”„ íŒíŠ¸ */}
          <div className="flex items-center justify-center gap-1.5 pt-1.5 pb-0.5 relative">
            {tabs.map((tab, idx) => (
              <div
                key={tab.key}
                className={`w-1.5 h-1.5 rounded-full transition-all duration-300 ${
                  idx === currentIndex
                    ? 'w-4 bg-pink-main'
                    : 'bg-gray-300 dark:bg-gray-600'
                }`}
              />
            ))}
            {/* ìŠ¤ì™€ì´í”„ íŒíŠ¸ ì• ë‹ˆë©”ì´ì…˜ */}
            {showSwipeHint && (
              <div className="absolute left-1/2 -translate-x-1/2 -top-8 bg-gray-800 dark:bg-gray-700 text-white text-xs px-3 py-1.5 rounded-full flex items-center gap-1.5 animate-bounce shadow-lg">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16l-4-4m0 0l4-4m-4 4h18" />
                </svg>
                <span>ìŠ¤ì™€ì´í”„ë¡œ ì´ë™</span>
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 8l4 4m0 0l-4 4m4-4H3" />
                </svg>
              </div>
            )}
          </div>
          {/* íƒ­ ë²„íŠ¼ */}
          <div className="flex items-center justify-around py-1">
            {tabs.map(tab => {
              const active = path === tab.key || (tab.key === 'friends' && path === '');
              return (
                <button
                  key={tab.key}
                  onClick={() => {
                    navigate(tab.key);
                    if (showSwipeHint) {
                      setShowSwipeHint(false);
                      localStorage.setItem('tokka_swipe_hint_seen', '1');
                    }
                  }}
                  className="flex flex-col items-center py-1 px-6 transition-all relative"
                >
                  {active && (
                    <div className="tab-active-bar absolute top-0 left-1/2 -translate-x-1/2 w-10 h-0.5 rounded-full" />
                  )}
                  <TabIcon name={tab.icon} active={active} />
                  <span className={`text-xs mt-0.5 ${active ? 'text-pink-main font-semibold' : 'text-gray-400'}`}>
                    {tab.label}
                  </span>
                </button>
              );
            })}
          </div>
        </div>
      );
    }

    // ì•± ì‰˜ (íƒ­ë°” í¬í•¨ ë ˆì´ì•„ì›ƒ)
    function AppShell({ children }) {
      return (
        <div className="flex flex-col h-screen">
          <div className="flex-1 overflow-hidden">
            {children}
          </div>
          <BottomTabBar />
        </div>
      );
    }

    // í˜ì´ì§€ í—¤ë”
    function PageHeader({ title, leftAction, rightAction }) {
      return (
        <div className="flex items-center justify-between px-4 py-3 bg-white border-b border-gray-100">
          <div className="w-10 flex justify-start">{leftAction || null}</div>
          <h1 className="text-lg font-bold text-gray-900">{title}</h1>
          <div className="w-10 flex justify-end">{rightAction || null}</div>
        </div>
      );
    }

    // ========================================
    // í˜ì´ì§€: ë¡œê·¸ì¸
    // ========================================
    function LoginPage() {
      const { login, showToast } = useApp();
      const { navigate } = useRouter();
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [submitting, setSubmitting] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!email || !password) {
          showToast('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
          return;
        }
        setSubmitting(true);
        try {
          await login(email, password);
          showToast('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
          navigate('friends');
        } catch (err) {
          showToast(err.message, 'error');
        } finally {
          setSubmitting(false);
        }
      };

      return (
        <div className="flex flex-col items-center justify-center h-screen px-8 bg-white">
          {/* ë¡œê³  */}
          <div className="mb-10 text-center">
            <div className="w-20 h-20 bg-pink-main rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-pink-main/30">
              <svg className="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" />
              </svg>
            </div>
            <h1 className="text-3xl font-extrabold text-gray-900">TOKKA</h1>
            <p className="text-gray-400 mt-1">ì¹´ì¹´ì˜¤í†¡ ìŠ¤íƒ€ì¼ ì±„íŒ…</p>
          </div>

          <form onSubmit={handleSubmit} className="w-full max-w-sm space-y-4">
            <Input
              type="email"
              placeholder="ì´ë©”ì¼"
              value={email}
              onChange={e => setEmail(e.target.value)}
              autoFocus
            />
            <Input
              type="password"
              placeholder="ë¹„ë°€ë²ˆí˜¸"
              value={password}
              onChange={e => setPassword(e.target.value)}
            />
            <Button variant="primary" size="full" type="submit" disabled={submitting}>
              {submitting ? 'ë¡œê·¸ì¸ ì¤‘...' : 'ë¡œê·¸ì¸'}
            </Button>
          </form>

          <p className="mt-6 text-sm text-gray-400">
            ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?{' '}
            <button
              onClick={() => navigate('register')}
              className="text-pink-main font-semibold hover:underline"
            >
              íšŒì›ê°€ì…
            </button>
          </p>
        </div>
      );
    }

    // ========================================
    // í˜ì´ì§€: íšŒì›ê°€ì…
    // ========================================
    function RegisterPage() {
      const { register: doRegister, showToast } = useApp();
      const { navigate } = useRouter();
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [nickname, setNickname] = useState('');
      const [submitting, setSubmitting] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!email || !password || !nickname) {
          showToast('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
          return;
        }
        if (password.length < 6) {
          showToast('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
          return;
        }
        setSubmitting(true);
        try {
          await doRegister(email, password, nickname);
          showToast('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'success');
          navigate('login');
        } catch (err) {
          showToast(err.message, 'error');
        } finally {
          setSubmitting(false);
        }
      };

      return (
        <div className="flex flex-col items-center justify-center h-screen px-8 bg-white">
          <div className="mb-10 text-center">
            <h1 className="text-2xl font-extrabold text-gray-900">íšŒì›ê°€ì…</h1>
            <p className="text-gray-400 mt-1">TOKKAì— ê°€ì…í•˜ì„¸ìš”</p>
          </div>

          <form onSubmit={handleSubmit} className="w-full max-w-sm space-y-4">
            <Input
              type="email"
              placeholder="ì´ë©”ì¼"
              value={email}
              onChange={e => setEmail(e.target.value)}
              autoFocus
            />
            <Input
              type="password"
              placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)"
              value={password}
              onChange={e => setPassword(e.target.value)}
            />
            <Input
              placeholder="ë‹‰ë„¤ì„"
              value={nickname}
              onChange={e => setNickname(e.target.value)}
            />
            <Button variant="primary" size="full" type="submit" disabled={submitting}>
              {submitting ? 'ê°€ì… ì¤‘...' : 'ê°€ì…í•˜ê¸°'}
            </Button>
          </form>

          <p className="mt-6 text-sm text-gray-400">
            ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?{' '}
            <button
              onClick={() => navigate('login')}
              className="text-pink-main font-semibold hover:underline"
            >
              ë¡œê·¸ì¸
            </button>
          </p>
        </div>
      );
    }

    // ========================================
    // í˜ì´ì§€: ì¹œêµ¬ ëª©ë¡
    // ========================================
    function FriendsPage() {
      const { user, showToast } = useApp();
      const { navigate } = useRouter();
      const [friends, setFriends] = useState([]);
      const [loading, setLoading] = useState(true);
      const [searchQuery, setSearchQuery] = useState('');
      const [showAddFriend, setShowAddFriend] = useState(false);
      const [showAddAIFriend, setShowAddAIFriend] = useState(false);
      const [selectedFriend, setSelectedFriend] = useState(null);

      // ì¹œêµ¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
      const loadFriends = useCallback(async () => {
        try {
          const data = await apiFetch('/friends');
          setFriends(data.friends || data || []);
        } catch (err) {
          showToast('ì¹œêµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        } finally {
          setLoading(false);
        }
      }, [showToast]);

      useEffect(() => {
        loadFriends();
      }, [loadFriends]);

      // ê²€ìƒ‰ í•„í„°
      const filteredFriends = useMemo(() => {
        if (!searchQuery) return friends;
        const q = searchQuery.toLowerCase();
        return friends.filter(f =>
          (f.nickname || '').toLowerCase().includes(q) ||
          (f.email || '').toLowerCase().includes(q)
        );
      }, [friends, searchQuery]);

      // 1:1 ì±„íŒ… ì‹œì‘
      const startChat = useCallback(async (friendId) => {
        try {
          const data = await apiFetch('/rooms', {
            method: 'POST',
            body: JSON.stringify({ type: 'direct', memberIds: [friendId] }),
          });
          const roomId = data.room?.id || data.id;
          setSelectedFriend(null);
          navigate(`chat/${roomId}`);
        } catch (err) {
          showToast(err.message, 'error');
        }
      }, [navigate, showToast]);

      return (
        <AppShell>
          <div className="flex flex-col h-full app-bg">
            {/* ê·¸ë¼ë°ì´ì…˜ í—¤ë” */}
            <div className="bg-gradient-to-br from-pink-main to-pink-dark px-4 pt-8 pb-4">
              <div className="flex items-center justify-between mb-4">
                <h1 className="text-2xl font-extrabold text-white">ì¹œêµ¬</h1>
                <div className="flex gap-2">
                  <button
                    onClick={() => setShowAddAIFriend(true)}
                    className="flex items-center gap-1.5 text-xs font-semibold bg-white/30 text-white px-3 py-1.5 rounded-full"
                  >
                    <span className="text-sm">ğŸ¤–</span>
                    AI ì¹œêµ¬
                  </button>
                  <button
                    onClick={() => setShowAddFriend(true)}
                    className="flex items-center gap-1.5 text-xs font-semibold bg-white/20 text-white px-3 py-1.5 rounded-full"
                  >
                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" />
                    </svg>
                    ì¹œêµ¬ ì¶”ê°€
                  </button>
                </div>
              </div>

              {/* ë‚´ í”„ë¡œí•„ (í—¤ë” ì•ˆ) */}
              {user && (
                <div className="flex items-center gap-3 mb-4 cursor-pointer" onClick={() => navigate('settings')}>
                  <div className="p-0.5 rounded-full bg-white/30 flex-shrink-0">
                    <Avatar src={user.profile_image} name={user.nickname} size="lg" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="font-bold text-white truncate text-base">{user.nickname}</p>
                    <p className="text-white/70 text-sm truncate">{user.status_message || 'ìƒíƒœ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'}</p>
                  </div>
                  <svg className="w-4 h-4 text-white/50 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                  </svg>
                </div>
              )}

              {/* ê²€ìƒ‰ë°” */}
              <div className="relative">
                <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input
                  type="text"
                  placeholder="ì¹œêµ¬ ê²€ìƒ‰"
                  value={searchQuery}
                  onChange={e => setSearchQuery(e.target.value)}
                  className="w-full pl-10 pr-4 py-2.5 bg-white/20 text-white placeholder-white/60 rounded-xl text-sm border-none"
                  style={{ outline: 'none', boxShadow: 'none' }}
                />
              </div>
            </div>

            {/* ì¹œêµ¬ ìˆ˜ ë¼ë²¨ */}
            <div className="px-4 py-2.5 bg-white dark:bg-gray-900/50 border-b border-gray-100 dark:border-gray-700">
              <span className="text-xs text-gray-400 dark:text-gray-500 font-semibold">ì¹œêµ¬ {friends.length}</span>
            </div>

            {/* ì¹œêµ¬ ëª©ë¡ */}
            <div className="flex-1 overflow-y-auto">
              {loading ? (
                <Spinner className="py-16" />
              ) : filteredFriends.length === 0 ? (
                <EmptyState
                  icon="ğŸ‘¥"
                  title={searchQuery ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤' : 'ì•„ì§ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤'}
                  description={searchQuery ? '' : 'ì¹œêµ¬ë¥¼ ì¶”ê°€í•˜ê³  ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!'}
                  action={!searchQuery && (
                    <Button variant="outline" size="sm" onClick={() => setShowAddFriend(true)}>
                      ì¹œêµ¬ ì¶”ê°€í•˜ê¸°
                    </Button>
                  )}
                />
              ) : (
                <div className="px-3 py-2 space-y-2">
                  {filteredFriends.map(friend => (
                    <div
                      key={friend.id}
                      className="theme-card flex items-center gap-3 px-4 py-3 rounded-2xl shadow-sm cursor-pointer active:opacity-75 transition-opacity"
                      onClick={() => setSelectedFriend(friend)}
                    >
                      <div className="relative flex-shrink-0">
                        <Avatar src={friend.profile_image} name={friend.nickname} size="sm" className="theme-ring" />
                        {friend.is_ai && (
                          <span className="absolute -bottom-0.5 -right-0.5 w-4 h-4 bg-gradient-to-br from-pink-main to-pink-dark rounded-full flex items-center justify-center text-[8px] border-2 border-white dark:border-gray-800">
                            ğŸ¤–
                          </span>
                        )}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-1.5">
                          <p className="font-semibold text-gray-900 dark:text-gray-100 truncate text-sm">{friend.nickname}</p>
                          {friend.is_ai && (
                            <span className="text-[9px] px-1 py-0.5 rounded bg-pink-main/10 text-pink-main font-semibold flex-shrink-0">AI</span>
                          )}
                        </div>
                        {friend.status_message ? (
                          <p className="text-xs text-gray-400 dark:text-gray-500 truncate">{friend.status_message}</p>
                        ) : (
                          <p className="text-xs text-gray-300 dark:text-gray-600 truncate">ìƒíƒœ ë©”ì‹œì§€ ì—†ìŒ</p>
                        )}
                      </div>
                      <svg className="w-4 h-4 text-gray-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                      </svg>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* ì¹œêµ¬ ì¶”ê°€ ëª¨ë‹¬ */}
          <AddFriendModal
            isOpen={showAddFriend}
            onClose={() => setShowAddFriend(false)}
            onAdded={loadFriends}
          />

          {/* AI ì¹œêµ¬ ì¶”ê°€ ëª¨ë‹¬ */}
          <AddAIFriendModal
            isOpen={showAddAIFriend}
            onClose={() => setShowAddAIFriend(false)}
            onAdded={loadFriends}
            existingFriends={friends}
          />

          {/* ì¹œêµ¬ í”„ë¡œí•„ ëª¨ë‹¬ */}
          <FriendProfileModal
            friend={selectedFriend}
            onClose={() => setSelectedFriend(null)}
            onChat={startChat}
            onRemove={async (friendId) => {
              try {
                await apiFetch(`/friends/${friendId}`, { method: 'DELETE' });
                showToast('ì¹œêµ¬ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.', 'success');
                setSelectedFriend(null);
                loadFriends();
              } catch (err) {
                showToast(err.message, 'error');
              }
            }}
            onBlock={async (friendId) => {
              try {
                await apiFetch(`/friends/${friendId}/block`, { method: 'POST' });
                showToast('ì¹œêµ¬ë¥¼ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤.', 'success');
                setSelectedFriend(null);
                loadFriends();
              } catch (err) {
                showToast(err.message, 'error');
              }
            }}
          />
        </AppShell>
      );
    }

    // AI ì¹œêµ¬ ì¶”ê°€ ëª¨ë‹¬
    function AddAIFriendModal({ isOpen, onClose, onAdded, existingFriends = [] }) {
      const { showToast } = useApp();
      const [personas, setPersonas] = useState([]);
      const [loading, setLoading] = useState(true);
      const [adding, setAdding] = useState(null);

      // ì´ë¯¸ ì¶”ê°€ëœ AI ì¹œêµ¬ì˜ persona ID ëª©ë¡
      const addedPersonaIds = useMemo(() => {
        return existingFriends
          .filter(f => f.is_ai && f.ai_persona_id)
          .map(f => f.ai_persona_id);
      }, [existingFriends]);

      useEffect(() => {
        if (isOpen) {
          setLoading(true);
          apiFetch('/ai-personas')
            .then(data => setPersonas(data.personas || data || []))
            .catch(err => showToast(err.message, 'error'))
            .finally(() => setLoading(false));
        }
      }, [isOpen, showToast]);

      const handleAdd = async (personaId) => {
        if (addedPersonaIds.includes(personaId)) return;
        setAdding(personaId);
        try {
          await apiFetch('/friends/ai', {
            method: 'POST',
            body: JSON.stringify({ personaId }),
          });
          showToast('AI ì¹œêµ¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
          onAdded();
          onClose();
        } catch (err) {
          showToast(err.message, 'error');
        } finally {
          setAdding(null);
        }
      };

      const isAlreadyAdded = (personaId) => addedPersonaIds.includes(personaId);

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="AI ì¹œêµ¬ ì¶”ê°€">
          <div className="space-y-3">
            <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
              ë‹¤ì–‘í•œ ì„±ê²©ì˜ AI ì¹œêµ¬ì™€ ëŒ€í™”ë¥¼ ë‚˜ëˆ ë³´ì„¸ìš”!
            </p>
            
            {loading ? (
              <Spinner className="py-8" />
            ) : personas.length > 0 ? (
              <div className="space-y-2 max-h-80 overflow-y-auto">
                {personas.map(p => {
                  const alreadyAdded = isAlreadyAdded(p.id);
                  return (
                    <div
                      key={p.id}
                      className={`flex items-center gap-3 p-3 rounded-2xl border-2 transition-colors ${
                        alreadyAdded 
                          ? 'border-gray-200 dark:border-gray-600 opacity-60 cursor-default' 
                          : 'border-gray-100 dark:border-gray-700 hover:border-pink-main/50 cursor-pointer'
                      }`}
                      onClick={() => !adding && !alreadyAdded && handleAdd(p.id)}
                    >
                      <div className="w-12 h-12 rounded-full overflow-hidden flex-shrink-0 bg-gradient-to-br from-pink-main to-pink-dark">
                        {p.avatar_url ? (
                          <img src={p.avatar_url} alt={p.display_name} className="w-full h-full object-cover" />
                        ) : (
                          <div className="w-full h-full flex items-center justify-center text-2xl text-white">ğŸ¤–</div>
                        )}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2">
                          <p className="font-bold text-gray-900 dark:text-white">{p.display_name}</p>
                          <span className="text-[10px] px-1.5 py-0.5 rounded bg-pink-main/10 text-pink-main font-semibold">AI</span>
                          {alreadyAdded && (
                            <span className="text-[10px] px-1.5 py-0.5 rounded bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 font-semibold">ì¹œêµ¬</span>
                          )}
                        </div>
                        <p className="text-xs text-gray-500 dark:text-gray-400 mt-0.5">{p.description}</p>
                        {p.personality_tags && p.personality_tags.length > 0 && (
                          <div className="flex gap-1 mt-1.5 flex-wrap">
                            {p.personality_tags.map((tag, i) => (
                              <span key={i} className="text-[10px] px-1.5 py-0.5 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400">
                                #{tag}
                              </span>
                            ))}
                          </div>
                        )}
                      </div>
                      <button
                        className={`flex-shrink-0 px-3 py-1.5 text-xs font-semibold rounded-full ${
                          alreadyAdded 
                            ? 'bg-gray-200 dark:bg-gray-600 text-gray-500 dark:text-gray-400 cursor-default' 
                            : 'bg-pink-main text-white disabled:opacity-50'
                        }`}
                        disabled={adding === p.id || alreadyAdded}
                      >
                        {alreadyAdded ? 'ì¶”ê°€ë¨' : adding === p.id ? '...' : 'ì¶”ê°€'}
                      </button>
                    </div>
                  );
                })}
              </div>
            ) : (
              <p className="text-center text-gray-400 text-sm py-8">
                ì‚¬ìš© ê°€ëŠ¥í•œ AI ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤
              </p>
            )}
          </div>
        </Modal>
      );
    }

    // ì¹œêµ¬ ì¶”ê°€ ëª¨ë‹¬
    function AddFriendModal({ isOpen, onClose, onAdded }) {
      const { showToast } = useApp();
      const [query, setQuery] = useState('');
      const [results, setResults] = useState([]);
      const [searching, setSearching] = useState(false);
      const [adding, setAdding] = useState({});

      const handleSearch = useCallback(async (searchQuery) => {
        const q = searchQuery !== undefined ? searchQuery : query;
        setSearching(true);
        try {
          const url = q.trim() ? `/users/search?q=${encodeURIComponent(q)}` : '/users/search';
          const data = await apiFetch(url);
          setResults(data.users || data || []);
        } catch (err) {
          showToast(err.message, 'error');
        } finally {
          setSearching(false);
        }
      }, [query, showToast]);

      const handleAdd = useCallback(async (userId) => {
        setAdding(prev => ({ ...prev, [userId]: true }));
        try {
          await apiFetch(`/friends/${userId}`, { method: 'POST' });
          showToast('ì¹œêµ¬ë¡œ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤!', 'success');
          setResults(prev => prev.filter(u => u.id !== userId));
          onAdded();
        } catch (err) {
          showToast(err.message, 'error');
        } finally {
          setAdding(prev => ({ ...prev, [userId]: false }));
        }
      }, [showToast, onAdded]);

      // ëª¨ë‹¬ ì—´ë¦´ ë•Œ ì „ì²´ ê°€ì…ì ë¡œë“œ, ë‹«ì„ ë•Œ ì´ˆê¸°í™”
      useEffect(() => {
        if (isOpen) {
          handleSearch('');
        } else {
          setQuery('');
          setResults([]);
        }
      }, [isOpen]);

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="ì¹œêµ¬ ì¶”ê°€">
          <div className="space-y-4">
            <div className="flex gap-2">
              <input
                type="text"
                placeholder="ì´ë©”ì¼ ë˜ëŠ” ë‹‰ë„¤ì„ìœ¼ë¡œ ê²€ìƒ‰"
                value={query}
                onChange={e => setQuery(e.target.value)}
                onKeyDown={e => e.key === 'Enter' && handleSearch()}
                className="flex-1 px-4 py-2.5 bg-gray-100 rounded-xl text-sm border border-transparent"
                autoFocus
              />
              <Button size="sm" onClick={handleSearch} disabled={searching}>
                ê²€ìƒ‰
              </Button>
            </div>

            {searching ? (
              <Spinner className="py-8" />
            ) : results.length > 0 ? (
              <div className="space-y-2 max-h-60 overflow-y-auto">
                {results.map(u => (
                  <div key={u.id} className="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-50">
                    <Avatar src={u.profile_image} name={u.nickname} size="sm" />
                    <div className="flex-1 min-w-0">
                      <p className="font-semibold text-sm truncate">{u.nickname}</p>
                      <p className="text-xs text-gray-400 truncate">{u.email}</p>
                    </div>
                    <Button
                      size="sm"
                      variant="outline"
                      onClick={() => handleAdd(u.id)}
                      disabled={adding[u.id]}
                    >
                      {adding[u.id] ? '...' : 'ì¶”ê°€'}
                    </Button>
                  </div>
                ))}
              </div>
            ) : !searching ? (
              <p className="text-center text-gray-400 text-sm py-8">
                {query ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤' : 'ê°€ì…ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤'}
              </p>
            ) : null}
          </div>
        </Modal>
      );
    }

    // ì¹œêµ¬ í”„ë¡œí•„ ëª¨ë‹¬
    function FriendProfileModal({ friend, onClose, onChat, onRemove, onBlock }) {
      if (!friend) return null;

      return (
        <div className="fixed inset-0 z-50 flex items-end justify-center overlay-in" onClick={onClose}>
          <div className="absolute inset-0 bg-black/50" />
          <div
            className="relative bg-white dark:bg-gray-900 w-full max-w-[420px] rounded-t-3xl sheet-up overflow-hidden max-h-[85vh] flex flex-col"
            onClick={e => e.stopPropagation()}
          >
            <div className="relative flex-shrink-0">
              <button
                onClick={onClose}
                className="absolute top-3 right-3 z-10 w-8 h-8 bg-black/30 rounded-full flex items-center justify-center text-white"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
              {friend.profile_image ? (
                <div className="w-full flex justify-center bg-gradient-to-b from-pink-main/20 to-transparent dark:from-pink-main/10 pt-6 pb-4 px-6">
                  <img
                    src={friend.profile_image}
                    alt={friend.nickname}
                    className="w-40 h-40 rounded-2xl object-contain bg-gray-100 dark:bg-gray-800 shadow-lg"
                  />
                </div>
              ) : (
                <div className="w-full flex justify-center bg-gradient-to-b from-pink-main/20 to-transparent dark:from-pink-main/10 pt-6 pb-4 px-6">
                  <div className="w-40 h-40 rounded-2xl bg-gray-100 dark:bg-gray-700 flex items-center justify-center shadow-lg">
                    <span className="text-5xl font-bold text-pink-main">
                      {(friend.nickname || '?').charAt(0).toUpperCase()}
                    </span>
                  </div>
                </div>
              )}
            </div>
            <div className="flex flex-col items-center px-4 mt-2 flex-shrink-0">
              <div className="flex items-center gap-2">
                <h3 className="text-xl font-bold text-gray-900 dark:text-white">{friend.nickname}</h3>
                {friend.is_ai && (
                  <span className="text-xs px-2 py-0.5 rounded-full bg-gradient-to-r from-pink-main to-pink-dark text-white font-semibold">
                    AI ì¹œêµ¬
                  </span>
                )}
              </div>
              <p className="text-sm text-gray-400 dark:text-gray-500 mt-1">{friend.status_message || ''}</p>
            </div>

            {/* ì•¡ì…˜ ë²„íŠ¼ */}
            <div className="flex gap-6 mt-6 pb-6 justify-center px-4">
              <button
                onClick={() => onChat(friend.id)}
                className="flex flex-col items-center gap-1.5"
              >
                <div className="w-12 h-12 bg-pink-main rounded-full flex items-center justify-center shadow-md shadow-pink-main/30">
                  <svg className="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
                  </svg>
                </div>
                <span className="text-xs text-gray-600 dark:text-gray-300 font-medium">1:1 ì±„íŒ…</span>
              </button>
              <button
                onClick={() => onRemove(friend.id)}
                className="flex flex-col items-center gap-1.5"
              >
                <div className="w-12 h-12 bg-gray-200 dark:bg-gray-600 rounded-full flex items-center justify-center">
                  <svg className="w-6 h-6 text-gray-500 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6" />
                  </svg>
                </div>
                <span className="text-xs text-gray-600 dark:text-gray-300 font-medium">ì‚­ì œ</span>
              </button>
              <button
                onClick={() => onBlock(friend.id)}
                className="flex flex-col items-center gap-1.5"
              >
                <div className="w-12 h-12 bg-gray-200 dark:bg-gray-600 rounded-full flex items-center justify-center">
                  <svg className="w-6 h-6 text-gray-500 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                  </svg>
                </div>
                <span className="text-xs text-gray-600 dark:text-gray-300 font-medium">ì°¨ë‹¨</span>
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ========================================
    // í˜ì´ì§€: ì±„íŒ… ëª©ë¡
    // ========================================
    function ChatsPage() {
      const { user, showToast } = useApp();
      const { navigate } = useRouter();
      const [rooms, setRooms] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showNewChat, setShowNewChat] = useState(false);

      // ì±„íŒ…ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
      const loadRooms = useCallback(async () => {
        try {
          const data = await apiFetch('/rooms');
          setRooms(data.rooms || data || []);
        } catch (err) {
          showToast('ì±„íŒ… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        } finally {
          setLoading(false);
        }
      }, [showToast]);

      useEffect(() => {
        loadRooms();
      }, [loadRooms]);

      // Supabase Realtime êµ¬ë… (ìƒˆ ë©”ì‹œì§€ ê°ì§€ -> ëª©ë¡ ê°±ì‹ )
      useEffect(() => {
        const channel = supabase
          .channel('chat-list-updates')
          .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'messages',
          }, (payload) => {
            // ìƒˆ ë©”ì‹œì§€ê°€ ì˜¤ë©´ ë°© ëª©ë¡ì„ ê°±ì‹ 
            loadRooms();
          })
          .subscribe();

        return () => {
          supabase.removeChannel(channel);
        };
      }, [loadRooms]);

      // ì±„íŒ…ë°© ì´ë¦„ ê²°ì •
      const getRoomDisplayName = useCallback((room) => {
        if (room.name) return room.name;
        // 1:1 ì±„íŒ…ì¸ ê²½ìš° ìƒëŒ€ë°© ì´ë¦„
        if (room.type === 'direct' && room.members) {
          const other = room.members.find(m => m.id !== user?.id);
          return other?.nickname || 'ì•Œ ìˆ˜ ì—†ìŒ';
        }
        if (room.other_user) return room.other_user.nickname;
        return 'ì±„íŒ…ë°©';
      }, [user]);

      // ì±„íŒ…ë°© ì•„ë°”íƒ€
      const getRoomAvatar = useCallback((room) => {
        if (room.type === 'direct') {
          if (room.members) {
            const other = room.members.find(m => m.id !== user?.id);
            return { src: other?.profile_image, name: other?.nickname || '?', is_ai: other?.is_ai };
          }
          if (room.other_user) {
            return { src: room.other_user.profile_image, name: room.other_user.nickname, is_ai: room.other_user.is_ai };
          }
        }
        return { src: null, name: room.name || 'ê·¸ë£¹', is_ai: false };
      }, [user]);

      return (
        <AppShell>
          <div className="flex flex-col h-full app-bg">
            {/* ê·¸ë¼ë°ì´ì…˜ í—¤ë” */}
            <div className="bg-gradient-to-br from-pink-main to-pink-dark px-4 pt-8 pb-4 flex items-end justify-between">
              <h1 className="text-2xl font-extrabold text-white">ì±„íŒ…</h1>
              <button
                onClick={() => setShowNewChat(true)}
                className="w-9 h-9 flex items-center justify-center text-white bg-white/20 rounded-full hover:bg-white/30 transition-colors"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                </svg>
              </button>
            </div>

            {/* ì±„íŒ… ëª©ë¡ */}
            <div className="flex-1 overflow-y-auto">
              {loading ? (
                <Spinner className="py-16" />
              ) : rooms.length === 0 ? (
                <EmptyState
                  icon="ğŸ’¬"
                  title="ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤"
                  description="ì¹œêµ¬ì—ê²Œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”!"
                />
              ) : (
                <div className="px-3 py-2 space-y-2">
                  {rooms.map(room => {
                    const avatar = getRoomAvatar(room);
                    const displayName = getRoomDisplayName(room);
                    const lastMsg = room.last_message || room.lastMessage;
                    return (
                      <div
                        key={room.id}
                        className="theme-card flex items-center gap-3 px-4 py-3 rounded-2xl shadow-sm cursor-pointer active:opacity-75 transition-opacity"
                        onClick={() => navigate(`chat/${room.id}`)}
                      >
                        <div className="relative flex-shrink-0">
                          <Avatar src={avatar.src} name={avatar.name} size="md" className="theme-ring" />
                          {avatar.is_ai && (
                            <span className="absolute -bottom-0.5 -right-0.5 w-4 h-4 bg-gradient-to-br from-pink-main to-pink-dark rounded-full flex items-center justify-center text-[8px] border-2 border-white dark:border-gray-800">
                              ğŸ¤–
                            </span>
                          )}
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-1.5 min-w-0">
                              <p className="font-semibold text-gray-900 dark:text-gray-100 truncate text-sm">{displayName}</p>
                              {avatar.is_ai && (
                                <span className="text-[9px] px-1 py-0.5 rounded bg-pink-main/10 text-pink-main font-semibold flex-shrink-0">AI</span>
                              )}
                            </div>
                            {lastMsg && (
                              <span className="text-xs flex-shrink-0 ml-2 font-medium" style={{ color: 'var(--theme-main)' }}>
                                {formatTime(lastMsg.created_at || lastMsg.createdAt)}
                              </span>
                            )}
                          </div>
                          <p className="text-sm text-gray-400 dark:text-gray-500 truncate mt-0.5">
                            {lastMsg?.content || 'ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤'}
                          </p>
                        </div>
                        {room.unread_count > 0 && (
                          <div className="w-5 h-5 bg-pink-main rounded-full flex items-center justify-center flex-shrink-0">
                            <span className="text-white text-xs font-bold">{room.unread_count}</span>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>

          {/* ìƒˆ ì±„íŒ… ë§Œë“¤ê¸° ëª¨ë‹¬ */}
          <NewChatModal
            isOpen={showNewChat}
            onClose={() => setShowNewChat(false)}
            onCreated={(roomId) => {
              setShowNewChat(false);
              navigate(`chat/${roomId}`);
            }}
          />
        </AppShell>
      );
    }

    // ìƒˆ ì±„íŒ…(ê·¸ë£¹) ë§Œë“¤ê¸° ëª¨ë‹¬
    function NewChatModal({ isOpen, onClose, onCreated }) {
      const { showToast } = useApp();
      const [friends, setFriends] = useState([]);
      const [selectedIds, setSelectedIds] = useState([]);
      const [groupName, setGroupName] = useState('');
      const [loading, setLoading] = useState(false);
      const [creating, setCreating] = useState(false);

      useEffect(() => {
        if (isOpen) {
          setLoading(true);
          apiFetch('/friends')
            .then(data => setFriends(data.friends || data || []))
            .catch(err => showToast(err.message, 'error'))
            .finally(() => setLoading(false));
          setSelectedIds([]);
          setGroupName('');
        }
      }, [isOpen, showToast]);

      const toggleSelect = (id) => {
        setSelectedIds(prev =>
          prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]
        );
      };

      const handleCreate = async () => {
        if (selectedIds.length === 0) {
          showToast('ëŒ€í™” ìƒëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
          return;
        }
        setCreating(true);
        try {
          const type = selectedIds.length === 1 ? 'direct' : 'group';
          const body = {
            type,
            memberIds: selectedIds,
          };
          if (type === 'group' && groupName.trim()) {
            body.name = groupName.trim();
          }
          const data = await apiFetch('/rooms', {
            method: 'POST',
            body: JSON.stringify(body),
          });
          const roomId = data.room?.id || data.id;
          onCreated(roomId);
        } catch (err) {
          showToast(err.message, 'error');
        } finally {
          setCreating(false);
        }
      };

      return (
        <FullModal isOpen={isOpen} onClose={onClose} title="ìƒˆ ì±„íŒ…"
          rightAction={
            <button
              onClick={handleCreate}
              disabled={creating || selectedIds.length === 0}
              className="text-pink-main font-semibold text-sm disabled:opacity-40"
            >
              {creating ? '...' : 'ì™„ë£Œ'}
            </button>
          }
        >
          <div className="p-4 space-y-4">
            {/* ê·¸ë£¹ ì´ë¦„ (2ëª… ì´ìƒ ì„ íƒ ì‹œ í‘œì‹œ) */}
            {selectedIds.length > 1 && (
              <input
                type="text"
                placeholder="ê·¸ë£¹ ì±„íŒ…ë°© ì´ë¦„ (ì„ íƒì‚¬í•­)"
                value={groupName}
                onChange={e => setGroupName(e.target.value)}
                className="w-full px-4 py-2.5 bg-gray-100 rounded-xl text-sm border border-transparent"
              />
            )}

            {/* ì„ íƒëœ ì¸ì› ìˆ˜ */}
            <p className="text-xs text-gray-400 font-medium">
              ëŒ€í™” ìƒëŒ€ ì„ íƒ {selectedIds.length > 0 && `(${selectedIds.length}ëª…)`}
            </p>

            {loading ? (
              <Spinner className="py-8" />
            ) : friends.length === 0 ? (
              <EmptyState icon="ğŸ‘¥" title="ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤" description="ë¨¼ì € ì¹œêµ¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”" />
            ) : (
              friends.map(friend => {
                const selected = selectedIds.includes(friend.id);
                return (
                  <div
                    key={friend.id}
                    className={`flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-colors ${
                      selected ? 'bg-pink-light' : 'hover:bg-gray-50'
                    }`}
                    onClick={() => toggleSelect(friend.id)}
                  >
                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0 ${
                      selected ? 'border-pink-main bg-pink-main' : 'border-gray-300'
                    }`}>
                      {selected && (
                        <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                        </svg>
                      )}
                    </div>
                    <Avatar src={friend.profile_image} name={friend.nickname} size="sm" />
                    <div className="flex-1 min-w-0">
                      <p className="font-semibold text-sm truncate">{friend.nickname}</p>
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </FullModal>
      );
    }

    // ========================================
    // í˜ì´ì§€: ì±„íŒ…ë°©
    // ========================================
    function ChatRoomPage({ roomId }) {
      const { user, showToast } = useApp();
      const { navigate } = useRouter();
      const [room, setRoom] = useState(null);
      const [messages, setMessages] = useState([]);
      const [inputText, setInputText] = useState('');
      const [loading, setLoading] = useState(true);
      const [sending, setSending] = useState(false);
      const [showMenu, setShowMenu] = useState(false);
      const [showInvite, setShowInvite] = useState(false);
      const [showEmoji, setShowEmoji] = useState(false);
      const messagesEndRef = useRef(null);
      const messagesContainerRef = useRef(null);
      const inputRef = useRef(null);

      // ìì£¼ ì“°ëŠ” ì´ëª¨ì§€ ëª©ë¡
      const emojiList = [
        'ğŸ˜€','ğŸ˜‚','ğŸ¥°','ğŸ˜','ğŸ˜˜','ğŸ˜Š','ğŸ˜','ğŸ¤—','ğŸ˜­','ğŸ˜±',
        'ğŸ¥º','ğŸ˜¡','ğŸ¤”','ğŸ‘','ğŸ‘','â¤ï¸','ğŸ”¥','ğŸ’¯','ğŸ‰','âœ¨',
        'ğŸ‘','ğŸ™','ğŸ’ª','ğŸ˜´','ğŸ¤®','ğŸ¤©','ğŸ˜ˆ','ğŸ‘»','ğŸ’€','ğŸ¤¡',
        'ğŸ•','ğŸ”','ğŸº','â˜•','ğŸ®','âš½','ğŸµ','ğŸ“¸','ğŸ’¬','ğŸ‘‹',
      ];

      const insertEmoji = (emoji) => {
        setInputText(prev => prev + emoji);
        setShowEmoji(false);
        inputRef.current?.focus();
      };

      // ë©”ì‹œì§€ì— sender ê°ì²´ë¥¼ ì •ê·œí™” (flat í•„ë“œ â†’ nested sender)
      const normalizeMsg = useCallback((msg, members) => {
        if (msg.sender?.nickname) return msg;
        const member = members?.find(m => m.id === msg.sender_id);
        return {
          ...msg,
          sender: {
            id: msg.sender_id,
            nickname: msg.sender_nickname || member?.nickname || '',
            profile_image: msg.sender_profile_image || member?.profile_image || '',
            is_ai: msg.sender_is_ai || member?.is_ai || false,
          },
        };
      }, []);

      // ì½ìŒ ì²˜ë¦¬ API í˜¸ì¶œ
      const markAsRead = useCallback(async () => {
        try {
          await apiFetch(`/rooms/${roomId}/read`, { method: 'PUT' });
        } catch (err) {
          // ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ (UXì— ì¹˜ëª…ì ì´ì§€ ì•ŠìŒ)
          console.log('ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:', err.message);
        }
      }, [roomId]);

      // ë°© ì •ë³´ + ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
      useEffect(() => {
        let isMounted = true;
        async function load() {
          try {
            const [roomData, msgData] = await Promise.all([
              apiFetch(`/rooms/${roomId}`),
              apiFetch(`/rooms/${roomId}/messages?limit=50`),
            ]);
            if (isMounted) {
              const r = roomData.room || roomData;
              setRoom(r);
              const rawMessages = msgData.messages || msgData || [];
              setMessages(rawMessages.map(m => normalizeMsg(m, r.members)));
              setLoading(false);
              // ì±„íŒ…ë°© ì§„ì… ì‹œ ì½ìŒ ì²˜ë¦¬
              markAsRead();
            }
          } catch (err) {
            if (isMounted) {
              showToast(err.message, 'error');
              navigate('chats');
            }
          }
        }
        load();
        return () => { isMounted = false; };
      }, [roomId, showToast, navigate, normalizeMsg, markAsRead]);

      // ìë™ ìŠ¤í¬ë¡¤ (ë©”ì‹œì§€ ë³€ê²½ ì‹œ + ì•½ê°„ì˜ ë”œë ˆì´ë¡œ ë Œë”ë§ ì™„ë£Œ í›„ ìŠ¤í¬ë¡¤)
      useEffect(() => {
        const scrollToBottom = () => {
          if (messagesEndRef.current) {
            messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
          }
          if (messagesContainerRef.current) {
            messagesContainerRef.current.scrollTop = messagesContainerRef.current.scrollHeight;
          }
        };
        scrollToBottom();
        // ì´ë¯¸ì§€/ë Œë”ë§ ì§€ì—° ëŒ€ë¹„ ì¶”ê°€ ìŠ¤í¬ë¡¤
        const timer = setTimeout(scrollToBottom, 100);
        return () => clearTimeout(timer);
      }, [messages]);

      // Supabase Realtime êµ¬ë… (ìƒˆ ë©”ì‹œì§€)
      useEffect(() => {
        const channel = supabase
          .channel(`room-${roomId}`)
          .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'messages',
            filter: `room_id=eq.${roomId}`,
          }, (payload) => {
            const rawMsg = payload.new;
            // Realtime ë©”ì‹œì§€ì— unread_count ì¶”ê°€ (ë©¤ë²„ìˆ˜ - 1, ë³´ë‚¸ ì‚¬ëŒì€ ì½ì€ ê²ƒ)
            const memberCount = room?.members?.filter(m => !m.left_at)?.length || 2;
            rawMsg.unread_count = Math.max(0, memberCount - 1);
            const newMsg = normalizeMsg(rawMsg, room?.members);
            setMessages(prev => {
              if (prev.some(m => m.id === newMsg.id)) return prev;
              return [...prev, newMsg];
            });
            // ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ì½ìŒ ì²˜ë¦¬ (í™”ë©´ì— ìˆì„ ë•Œë§Œ)
            if (document.visibilityState === 'visible') {
              markAsRead();
            }
          })
          .subscribe();

        return () => {
          supabase.removeChannel(channel);
        };
      }, [roomId, room, normalizeMsg, markAsRead]);

      // í˜ì´ì§€ í¬ì»¤ìŠ¤ ë³µê·€ ì‹œ ì½ìŒ ì²˜ë¦¬
      useEffect(() => {
        const handleVisibility = () => {
          if (document.visibilityState === 'visible') {
            markAsRead();
          }
        };
        document.addEventListener('visibilitychange', handleVisibility);
        return () => document.removeEventListener('visibilitychange', handleVisibility);
      }, [markAsRead]);

      // ì½ìŒ ìƒíƒœ ë³€ê²½ Realtime êµ¬ë… (ìƒëŒ€ë°©ì´ ì½ìœ¼ë©´ unread_count ê°±ì‹ )
      useEffect(() => {
        const channel = supabase
          .channel(`room-${roomId}-read`)
          .on('postgres_changes', {
            event: 'UPDATE',
            schema: 'public',
            table: 'chat_room_members',
            filter: `room_id=eq.${roomId}`,
          }, async (payload) => {
            // ìƒëŒ€ë°©ì´ ì½ìŒ ì²˜ë¦¬í•˜ë©´ (ë‚´ê°€ ì•„ë‹Œ ê²½ìš°) ë©”ì‹œì§€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ unread_count ê°±ì‹ 
            if (payload.new.user_id !== user?.id) {
              try {
                const msgData = await apiFetch(`/rooms/${roomId}/messages?limit=50`);
                const rawMessages = msgData.messages || msgData || [];
                setMessages(rawMessages.map(m => normalizeMsg(m, room?.members)));
              } catch (err) {
                console.log('ì½ìŒ ìƒíƒœ ê°±ì‹  ì‹¤íŒ¨:', err.message);
              }
            }
          })
          .subscribe();

        return () => {
          supabase.removeChannel(channel);
        };
      }, [roomId, user, room, normalizeMsg]);

      // ë©”ì‹œì§€ ì „ì†¡
      const sendMessage = useCallback(async () => {
        const content = inputText.trim();
        if (!content || sending) return;

        setSending(true);
        setInputText('');
        // textarea ë†’ì´ë„ ë¦¬ì…‹
        if (inputRef.current) {
          inputRef.current.style.height = '40px';
        }

        // ë‚™ê´€ì  ì—…ë°ì´íŠ¸ (unread_count = ë©¤ë²„ìˆ˜ - 1)
        const memberCount = room?.members?.filter(m => !m.left_at)?.length || 2;
        const optimisticMsg = {
          id: 'temp-' + Date.now(),
          room_id: roomId,
          sender_id: user?.id,
          content,
          created_at: new Date().toISOString(),
          sender: user,
          unread_count: Math.max(0, memberCount - 1),
          _optimistic: true,
        };
        setMessages(prev => [...prev, optimisticMsg]);

        try {
          const data = await apiFetch(`/rooms/${roomId}/messages`, {
            method: 'POST',
            body: JSON.stringify({ content }),
          });
          // Realtimeì—ì„œ ì‹¤ì œ ë©”ì‹œì§€ê°€ ì˜¬ ë•Œ optimistic ë©”ì‹œì§€ì™€ êµì²´ë¨
          // ë§Œì•½ Realtimeì´ ëŠë¦¬ë©´ ì„œë²„ ì‘ë‹µìœ¼ë¡œ êµì²´
          const serverMsg = data.message || data;
          setMessages(prev => {
            const withoutOptimistic = prev.filter(m => m.id !== optimisticMsg.id);
            // ì´ë¯¸ Realtimeìœ¼ë¡œ ë°›ì•˜ëŠ”ì§€ í™•ì¸
            if (withoutOptimistic.some(m => m.id === serverMsg.id)) return withoutOptimistic;
            return [...withoutOptimistic, serverMsg];
          });
        } catch (err) {
          // ì‹¤íŒ¨ ì‹œ ë‚™ê´€ì  ë©”ì‹œì§€ ì œê±°
          setMessages(prev => prev.filter(m => m.id !== optimisticMsg.id));
          showToast(err.message, 'error');
          setInputText(content);
        } finally {
          setSending(false);
        }
      }, [inputText, sending, roomId, user, showToast]);

      // Enterë¡œ ì „ì†¡, Shift+EnterëŠ” ì¤„ë°”ê¿ˆ
      const handleKeyDown = useCallback((e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      }, [sendMessage]);

      // ë°© ë‚˜ê°€ê¸°
      const handleLeave = useCallback(async () => {
        if (!confirm('ì •ë§ë¡œ ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
          await apiFetch(`/rooms/${roomId}/leave`, { method: 'POST' });
          showToast('ì±„íŒ…ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.', 'success');
          navigate('chats');
        } catch (err) {
          showToast(err.message, 'error');
        }
      }, [roomId, navigate, showToast]);

      // ë°© ì´ë¦„ ë° AI ì—¬ë¶€
      const { roomName, isAIRoom } = useMemo(() => {
        if (!room) return { roomName: '', isAIRoom: false };
        if (room.name) return { roomName: room.name, isAIRoom: false };
        if (room.type === 'direct' && room.members) {
          const other = room.members.find(m => m.id !== user?.id);
          return { roomName: other?.nickname || 'ì±„íŒ…ë°©', isAIRoom: other?.is_ai || false };
        }
        if (room.other_user) return { roomName: room.other_user.nickname, isAIRoom: room.other_user.is_ai || false };
        return { roomName: 'ì±„íŒ…ë°©', isAIRoom: false };
      }, [room, user]);

      if (loading) {
        return (
          <div className="flex items-center justify-center h-screen bg-pink-light/30">
            <Spinner size="lg" />
          </div>
        );
      }

      return (
        <div className="flex flex-col h-screen bg-pink-light/30">
          {/* ìƒë‹¨ í—¤ë” */}
          <div className="flex items-center gap-3 px-3 py-2.5 bg-white border-b border-gray-100">
            <button onClick={() => navigate('chats')} className="p-1 text-gray-600">
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-1.5">
                <p className="font-bold text-gray-900 truncate">{roomName}</p>
                {isAIRoom && (
                  <span className="text-[9px] px-1.5 py-0.5 rounded-full bg-gradient-to-r from-pink-main to-pink-dark text-white font-semibold flex-shrink-0">AI</span>
                )}
              </div>
              {room?.members && (
                <p className="text-xs text-gray-400">{room.members.length}ëª…</p>
              )}
            </div>
            <div className="relative">
              <button
                onClick={() => setShowMenu(!showMenu)}
                className="p-1 text-gray-600"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 5v.01M12 12v.01M12 19v.01" />
                </svg>
              </button>
              {showMenu && (
                <>
                  <div className="fixed inset-0 z-40" onClick={() => setShowMenu(false)} />
                  <div className="absolute right-0 top-full mt-1 w-36 bg-white rounded-xl shadow-lg border border-gray-100 z-50 overflow-hidden">
                    {room?.type === 'group' && (
                      <button
                        onClick={() => { setShowMenu(false); setShowInvite(true); }}
                        className="w-full px-4 py-3 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2"
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                        </svg>
                        ë©¤ë²„ ì´ˆëŒ€
                      </button>
                    )}
                    <button
                      onClick={() => { setShowMenu(false); handleLeave(); }}
                      className="w-full px-4 py-3 text-left text-sm text-red-500 hover:bg-red-50 flex items-center gap-2"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                      </svg>
                      ë‚˜ê°€ê¸°
                    </button>
                  </div>
                </>
              )}
            </div>
          </div>

          {/* ë©”ì‹œì§€ ëª©ë¡ */}
          <div ref={messagesContainerRef} className="flex-1 overflow-y-auto px-4 py-3">
            {messages.map((msg, idx) => {
              const isMe = msg.sender_id === user?.id;
              const prevMsg = messages[idx - 1];
              const showDateDivider = !prevMsg || !isSameDay(prevMsg.created_at, msg.created_at);
              // ê°™ì€ ì‚¬ëŒì´ ì—°ì†ìœ¼ë¡œ ë³´ë‚¸ ë©”ì‹œì§€ì¸ì§€ (1ë¶„ ì´ë‚´)
              const isContinuous = prevMsg &&
                prevMsg.sender_id === msg.sender_id &&
                isSameDay(prevMsg.created_at, msg.created_at) &&
                (new Date(msg.created_at) - new Date(prevMsg.created_at)) < 60000;
              // ë‹¤ìŒ ë©”ì‹œì§€ì™€ ê°™ì€ ì‹œê°„ëŒ€ì¸ì§€ (ì‹œê°„ í‘œì‹œ ê²°ì •ìš©)
              const nextMsg = messages[idx + 1];
              const showTime = !nextMsg ||
                nextMsg.sender_id !== msg.sender_id ||
                !isSameDay(msg.created_at, nextMsg.created_at) ||
                (new Date(nextMsg.created_at) - new Date(msg.created_at)) >= 60000;

              // ë°œì‹ ì ì •ë³´
              const senderName = msg.sender?.nickname ||
                (room?.members?.find(m => m.id === msg.sender_id)?.nickname) ||
                '';
              const senderIsAI = msg.sender?.is_ai ||
                (room?.members?.find(m => m.id === msg.sender_id)?.is_ai) ||
                false;

              return (
                <React.Fragment key={msg.id}>
                  {/* ë‚ ì§œ êµ¬ë¶„ì„  */}
                  {showDateDivider && (
                    <div className="flex items-center justify-center my-4">
                      <span className="px-3 py-1 bg-gray-900/10 rounded-full text-xs text-gray-500">
                        {formatDateDivider(msg.created_at)}
                      </span>
                    </div>
                  )}

                  {/* ë©”ì‹œì§€ */}
                  <div className={`flex ${isMe ? 'justify-end' : 'justify-start'} ${isContinuous ? 'mt-0.5' : 'mt-3'}`}>
                    {/* ìƒëŒ€ë°© ì•„ë°”íƒ€ */}
                    {!isMe && !isContinuous && (
                      <div className="relative mt-1 mr-2 flex-shrink-0">
                        <Avatar
                          src={msg.sender?.profile_image}
                          name={senderName}
                          size="xs"
                        />
                        {senderIsAI && (
                          <span className="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-gradient-to-br from-pink-main to-pink-dark rounded-full flex items-center justify-center text-[7px] border border-white">
                            ğŸ¤–
                          </span>
                        )}
                      </div>
                    )}
                    {!isMe && isContinuous && <div className="w-8 mr-2 flex-shrink-0" />}

                    <div className={`flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[70%]`}>
                      {/* ë°œì‹ ì ì´ë¦„ (ê·¸ë£¹ ì±„íŒ… + ìƒëŒ€ë°© + ì²« ë©”ì‹œì§€) */}
                      {!isMe && !isContinuous && room?.type === 'group' && (
                        <div className="flex items-center gap-1 mb-1 ml-1">
                          <span className="text-xs text-gray-500">{senderName}</span>
                          {senderIsAI && (
                            <span className="text-[8px] px-1 py-0.5 rounded bg-pink-main/10 text-pink-main font-semibold">AI</span>
                          )}
                        </div>
                      )}

                      <div className={`flex items-end gap-1.5 ${isMe ? 'flex-row-reverse' : ''}`}>
                        {/* ë§í’ì„  */}
                        <div
                          className={`px-3.5 py-2 rounded-2xl text-sm leading-relaxed whitespace-pre-wrap break-words ${
                            isMe
                              ? 'bg-pink-main text-white rounded-tr-md'
                              : 'bg-gray-100 text-gray-900 rounded-tl-md'
                          } ${msg._optimistic ? 'opacity-70' : ''}`}
                        >
                          {msg.content}
                        </div>
                        {/* ì½ì§€ ì•Šì€ ìˆ˜ + ì‹œê°„ */}
                        {showTime && (
                          <div className={`flex flex-col flex-shrink-0 mb-0.5 ${isMe ? 'items-end' : 'items-start'}`}>
                            {isMe && msg.unread_count > 0 && (
                              <span className="text-[10px] font-medium" style={{ color: 'var(--theme-main)' }}>
                                {msg.unread_count}
                              </span>
                            )}
                            <span className="text-[10px] text-gray-400">
                              {formatMessageTime(msg.created_at)}
                            </span>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </React.Fragment>
              );
            })}
            <div ref={messagesEndRef} />
          </div>

          {/* ì´ëª¨ì§€ í”¼ì»¤ */}
          {showEmoji && (
            <div className="bg-white border-t border-gray-100 px-3 pt-2">
              <div className="grid grid-cols-8 gap-1 max-h-36 overflow-y-auto p-2 bg-gray-50 rounded-xl">
                {emojiList.map((emoji, i) => (
                  <button
                    key={i}
                    onClick={() => insertEmoji(emoji)}
                    className="w-9 h-9 flex items-center justify-center text-xl hover:bg-gray-200 rounded-lg transition-colors"
                  >
                    {emoji}
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* ë©”ì‹œì§€ ì…ë ¥ */}
          <div className="bg-white border-t border-gray-100 px-3 py-2">
            <div className="flex items-end gap-2">
              {/* ì´ëª¨ì§€ ë²„íŠ¼ */}
              <button
                onClick={() => setShowEmoji(prev => !prev)}
                className={`w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 transition-all ${
                  showEmoji ? 'bg-pink-light text-pink-main' : 'text-gray-400 hover:text-gray-600'
                }`}
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </button>
              <textarea
                ref={inputRef}
                value={inputText}
                onChange={e => setInputText(e.target.value)}
                onKeyDown={handleKeyDown}
                onFocus={() => setShowEmoji(false)}
                placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                rows={1}
                className="flex-1 resize-none px-4 py-2.5 bg-gray-100 rounded-2xl text-sm border-none max-h-24 leading-snug"
                style={{ minHeight: '40px' }}
                onInput={e => {
                  e.target.style.height = 'auto';
                  e.target.style.height = Math.min(e.target.scrollHeight, 96) + 'px';
                }}
              />
              <button
                onClick={sendMessage}
                disabled={!inputText.trim() || sending}
                className={`w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 transition-all ${
                  inputText.trim()
                    ? 'bg-pink-main text-white shadow-md shadow-pink-main/30'
                    : 'bg-gray-200 text-gray-400'
                }`}
              >
                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                </svg>
              </button>
            </div>
          </div>

          {/* ë©¤ë²„ ì´ˆëŒ€ ëª¨ë‹¬ */}
          <InviteModal
            isOpen={showInvite}
            onClose={() => setShowInvite(false)}
            roomId={roomId}
            currentMembers={room?.members || []}
          />
        </div>
      );
    }

    // ë©¤ë²„ ì´ˆëŒ€ ëª¨ë‹¬
    function InviteModal({ isOpen, onClose, roomId, currentMembers }) {
      const { showToast } = useApp();
      const [friends, setFriends] = useState([]);
      const [selectedIds, setSelectedIds] = useState([]);
      const [loading, setLoading] = useState(false);
      const [inviting, setInviting] = useState(false);

      const currentMemberIds = useMemo(() => currentMembers.map(m => m.id), [currentMembers]);

      useEffect(() => {
        if (isOpen) {
          setLoading(true);
          apiFetch('/friends')
            .then(data => {
              const allFriends = data.friends || data || [];
              // ì´ë¯¸ ë°©ì— ìˆëŠ” ì‚¬ëŒ ì œì™¸
              setFriends(allFriends.filter(f => !currentMemberIds.includes(f.id)));
            })
            .catch(err => showToast(err.message, 'error'))
            .finally(() => setLoading(false));
          setSelectedIds([]);
        }
      }, [isOpen, showToast, currentMemberIds]);

      const handleInvite = async () => {
        if (selectedIds.length === 0) return;
        setInviting(true);
        try {
          await apiFetch(`/rooms/${roomId}/invite`, {
            method: 'POST',
            body: JSON.stringify({ userIds: selectedIds }),
          });
          showToast('ë©¤ë²„ë¥¼ ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤!', 'success');
          onClose();
        } catch (err) {
          showToast(err.message, 'error');
        } finally {
          setInviting(false);
        }
      };

      return (
        <FullModal isOpen={isOpen} onClose={onClose} title="ë©¤ë²„ ì´ˆëŒ€"
          rightAction={
            <button
              onClick={handleInvite}
              disabled={inviting || selectedIds.length === 0}
              className="text-pink-main font-semibold text-sm disabled:opacity-40"
            >
              {inviting ? '...' : 'ì´ˆëŒ€'}
            </button>
          }
        >
          <div className="p-4">
            {loading ? (
              <Spinner className="py-8" />
            ) : friends.length === 0 ? (
              <EmptyState icon="ğŸ‘¥" title="ì´ˆëŒ€í•  ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤" />
            ) : (
              friends.map(friend => {
                const selected = selectedIds.includes(friend.id);
                return (
                  <div
                    key={friend.id}
                    className={`flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-colors ${
                      selected ? 'bg-pink-light' : 'hover:bg-gray-50'
                    }`}
                    onClick={() => setSelectedIds(prev =>
                      prev.includes(friend.id) ? prev.filter(x => x !== friend.id) : [...prev, friend.id]
                    )}
                  >
                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0 ${
                      selected ? 'border-pink-main bg-pink-main' : 'border-gray-300'
                    }`}>
                      {selected && (
                        <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                        </svg>
                      )}
                    </div>
                    <Avatar src={friend.profile_image} name={friend.nickname} size="sm" />
                    <p className="font-semibold text-sm">{friend.nickname}</p>
                  </div>
                );
              })
            )}
          </div>
        </FullModal>
      );
    }

    // ========================================
    // í˜ì´ì§€: ì„¤ì • / í”„ë¡œí•„
    // ========================================
    function SettingsPage() {
      const { user, logout, updateUser, showToast } = useApp();
      const [editing, setEditing] = useState(false);
      const [nickname, setNickname] = useState(user?.nickname || '');
      const [statusMessage, setStatusMessage] = useState(user?.status_message || '');
      const [saving, setSaving] = useState(false);
      const [uploading, setUploading] = useState(false);
      const [showPhotoPreview, setShowPhotoPreview] = useState(false);
      const [currentTheme, setCurrentTheme] = useState(localStorage.getItem('tokka_theme') || 'pink');
      const [showThemePicker, setShowThemePicker] = useState(false);
      const [isDark, setIsDark] = useState(() => localStorage.getItem('tokka_dark') === '1');
      const fileInputRef = useRef(null);

      useEffect(() => {
        setIsDark(localStorage.getItem('tokka_dark') === '1');
      }, []);
      const [showBlocked, setShowBlocked] = useState(false);
      const [blockedUsers, setBlockedUsers] = useState([]);
      const [loadingBlocked, setLoadingBlocked] = useState(false);

      // í…Œë§ˆ ë³€ê²½
      const handleThemeChange = (themeId) => {
        applyTheme(themeId);
        setCurrentTheme(themeId);
        setShowThemePicker(false);
      };

      // ì°¨ë‹¨ëœ ìœ ì € ëª©ë¡ ì¡°íšŒ
      const fetchBlockedUsers = async () => {
        setLoadingBlocked(true);
        try {
          const data = await apiFetch('/friends/blocked');
          setBlockedUsers(data);
        } catch (err) {
          showToast(err.message, 'error');
        } finally {
          setLoadingBlocked(false);
        }
      };

      // ì°¨ë‹¨ í•´ì œ
      const handleUnblock = async (userId) => {
        try {
          await apiFetch(`/friends/${userId}/unblock`, { method: 'POST' });
          setBlockedUsers(prev => prev.filter(u => u.id !== userId));
          showToast('ì°¨ë‹¨ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } catch (err) {
          showToast(err.message, 'error');
        }
      };

      useEffect(() => {
        if (user) {
          setNickname(user.nickname || '');
          setStatusMessage(user.status_message || '');
        }
      }, [user]);

      // í”„ë¡œí•„ ìˆ˜ì • ì €ì¥
      const handleSave = async () => {
        setSaving(true);
        try {
          const data = await apiFetch('/users/profile', {
            method: 'PUT',
            body: JSON.stringify({ nickname, status_message: statusMessage }),
          });
          updateUser({ nickname, status_message: statusMessage });
          showToast('í”„ë¡œí•„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          setEditing(false);
        } catch (err) {
          showToast(err.message, 'error');
        } finally {
          setSaving(false);
        }
      };

      // í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ìë™ ì••ì¶•)
      const handleImageUpload = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        setUploading(true);
        try {
          // ì´ë¯¸ì§€ ì••ì¶• (800x800, JPEG 80%)
          const compressedBlob = await compressImage(file, 800, 800, 0.8);
          
          // ì••ì¶• í›„ì—ë„ 4MB ì´ˆê³¼ ì‹œ ì—ëŸ¬ (ì•ˆì „ì¥ì¹˜)
          if (compressedBlob.size > 4 * 1024 * 1024) {
            showToast('ì´ë¯¸ì§€ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            setUploading(false);
            return;
          }

          // Blobì„ File ê°ì²´ë¡œ ë³€í™˜ (MIME íƒ€ì… ëª…ì‹œ)
          const compressedFile = new File([compressedBlob], 'profile.jpg', { type: 'image/jpeg' });
          
          const formData = new FormData();
          formData.append('image', compressedFile);

          const data = await apiFetch('/users/profile-image', {
            method: 'POST',
            body: formData,
          });
          updateUser({ profile_image: data.profile_image });
          showToast('í”„ë¡œí•„ ì‚¬ì§„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } catch (err) {
          showToast(err.message, 'error');
        } finally {
          setUploading(false);
        }
      };

      return (
        <AppShell>
          <div className="flex flex-col h-full app-bg">
            {/* ê·¸ë¼ë°ì´ì…˜ í—¤ë” + í”„ë¡œí•„ í†µí•© */}
            <div className="bg-gradient-to-br from-pink-main to-pink-dark px-4 pt-8 pb-6 text-white">
              <div className="flex items-center justify-between mb-5">
                <h1 className="text-2xl font-extrabold text-white">ì„¤ì •</h1>
                {!editing && (
                  <button
                    onClick={() => setEditing(true)}
                    className="text-sm text-white font-semibold bg-white/20 px-3 py-1.5 rounded-xl hover:bg-white/30"
                  >
                    í¸ì§‘
                  </button>
                )}
              </div>

              {/* í”„ë¡œí•„ */}
              <div className="flex flex-col items-center">
                <div className="relative">
                  <div className="p-0.5 rounded-full bg-white/30">
                    <Avatar
                      src={user?.profile_image}
                      name={user?.nickname}
                      size="2xl"
                      className="border-4 border-white/20"
                      onClick={() => {
                        if (!editing && user?.profile_image) {
                          setShowPhotoPreview(true);
                        }
                      }}
                    />
                  </div>
                  {editing && (
                    <button
                      onClick={() => fileInputRef.current?.click()}
                      disabled={uploading}
                      className="absolute bottom-1 right-1 w-9 h-9 bg-white rounded-full flex items-center justify-center shadow-lg"
                    >
                      {uploading ? (
                        <div className="w-4 h-4 border-2 border-pink-main border-t-transparent rounded-full animate-spin" />
                      ) : (
                        <svg className="w-5 h-5 text-pink-main" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                      )}
                    </button>
                  )}
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept="image/*"
                    className="hidden"
                    onChange={handleImageUpload}
                  />
                </div>

                {editing ? (
                  <div className="mt-4 w-full space-y-3">
                    <input
                      type="text"
                      value={nickname}
                      onChange={e => setNickname(e.target.value)}
                      placeholder="ë‹‰ë„¤ì„"
                      className="w-full px-4 py-2.5 bg-white/20 rounded-xl text-white placeholder-white/60 text-center font-bold border-none"
                      style={{ outline: 'none', boxShadow: 'none' }}
                    />
                    <input
                      type="text"
                      value={statusMessage}
                      onChange={e => setStatusMessage(e.target.value)}
                      placeholder="ìƒíƒœ ë©”ì‹œì§€"
                      className="w-full px-4 py-2.5 bg-white/20 rounded-xl text-white placeholder-white/60 text-center text-sm border-none"
                      style={{ outline: 'none', boxShadow: 'none' }}
                    />
                    <div className="flex gap-2 pt-2">
                      <Button
                        variant="ghost"
                        size="sm"
                        className="flex-1 !text-white hover:!bg-white/10"
                        onClick={() => {
                          setEditing(false);
                          setNickname(user?.nickname || '');
                          setStatusMessage(user?.status_message || '');
                        }}
                      >
                        ì·¨ì†Œ
                      </Button>
                      <button
                        onClick={handleSave}
                        disabled={saving}
                        className="flex-1 py-1.5 bg-white text-pink-main rounded-xl font-semibold text-sm hover:bg-white/90 disabled:opacity-50"
                      >
                        {saving ? 'ì €ì¥ ì¤‘...' : 'ì €ì¥'}
                      </button>
                    </div>
                  </div>
                ) : (
                  <>
                    <h2 className="mt-4 text-xl font-bold">{user?.nickname}</h2>
                    <p className="text-white/70 text-sm mt-1">
                      {user?.status_message || 'ìƒíƒœ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'}
                    </p>
                    <p className="text-white/50 text-xs mt-2">{user?.email}</p>
                  </>
                )}
              </div>
            </div>

            <div className="flex-1 overflow-y-auto">
              {/* ë©”ë‰´ í•­ëª©ë“¤ */}
              <div className="mt-4 mx-4">
                <div className="bg-gray-50 dark:bg-gray-800/80 rounded-2xl overflow-hidden">
                  <button
                    onClick={() => setEditing(true)}
                    className="w-full flex items-center gap-3 px-4 py-3.5 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                  >
                    <div className="w-9 h-9 bg-blue-100 rounded-xl flex items-center justify-center">
                      <svg className="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                      </svg>
                    </div>
                    <span className="text-sm font-medium text-gray-700 dark:text-gray-200">í”„ë¡œí•„ ìˆ˜ì •</span>
                    <svg className="w-5 h-5 text-gray-300 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                    </svg>
                  </button>
                  <div className="h-px bg-gray-200 dark:bg-gray-600 mx-4" />
                  <button
                    onClick={() => { applyDarkMode(!isDark); setIsDark(!isDark); }}
                    className="w-full flex items-center gap-3 px-4 py-3.5 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                  >
                    <div className="w-9 h-9 bg-indigo-100 dark:bg-indigo-900/50 rounded-xl flex items-center justify-center text-lg">
                      {isDark ? 'â˜€ï¸' : 'ğŸŒ™'}
                    </div>
                    <span className="text-sm font-medium text-gray-700 dark:text-gray-200 flex-1 text-left">
                      ë‹¤í¬ ëª¨ë“œ
                    </span>
                    <div className={`w-11 h-6 rounded-full relative transition-colors flex-shrink-0 ${isDark ? 'bg-pink-main' : 'bg-gray-300 dark:bg-gray-600'}`}>
                      <div className={`absolute top-0.5 w-5 h-5 rounded-full bg-white shadow transition-all ${isDark ? 'left-6' : 'left-0.5'}`} />
                    </div>
                  </button>
                  <div className="h-px bg-gray-200 dark:bg-gray-600 mx-4" />
                  <button
                    onClick={() => setShowThemePicker(true)}
                    className="w-full flex items-center gap-3 px-4 py-3.5 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                  >
                    <div className="w-9 h-9 bg-purple-100 dark:bg-purple-900/50 rounded-xl flex items-center justify-center text-lg">
                      ğŸ¨
                    </div>
                    <div className="flex-1 text-left">
                      <span className="text-sm font-medium text-gray-700">í…Œë§ˆ ë³€ê²½</span>
                      <span className="block text-xs text-gray-400 mt-0.5">
                        {THEMES.find(t => t.id === currentTheme)?.emoji} {THEMES.find(t => t.id === currentTheme)?.label}
                      </span>
                    </div>
                    <svg className="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                    </svg>
                  </button>
                  <div className="h-px bg-gray-200 mx-4" />
                  <button
                    onClick={() => { setShowBlocked(true); fetchBlockedUsers(); }}
                    className="w-full flex items-center gap-3 px-4 py-3.5 hover:bg-gray-100 transition-colors"
                  >
                    <div className="w-9 h-9 bg-red-100 rounded-xl flex items-center justify-center">
                      <svg className="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                      </svg>
                    </div>
                    <span className="text-sm font-medium text-gray-700">ì°¨ë‹¨ ê´€ë¦¬</span>
                    <svg className="w-5 h-5 text-gray-300 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                    </svg>
                  </button>
                </div>
              </div>

              {/* ë¡œê·¸ì•„ì›ƒ */}
              <div className="mt-4 mx-4 mb-8">
                <button
                  onClick={logout}
                  className="w-full flex items-center gap-3 px-4 py-3.5 bg-gray-50 rounded-2xl hover:bg-red-50 transition-colors"
                >
                  <div className="w-9 h-9 bg-red-100 rounded-xl flex items-center justify-center">
                    <svg className="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                  </div>
                  <span className="text-sm font-medium text-red-500">ë¡œê·¸ì•„ì›ƒ</span>
                </button>
              </div>

              {/* ì•± ì •ë³´ */}
              <div className="text-center pb-8">
                <p className="text-xs text-gray-300">TOKKA v1.0.0</p>
              </div>
            </div>

            {/* ì°¨ë‹¨ ê´€ë¦¬ ëª¨ë‹¬ */}
            {showBlocked && (
              <div className="absolute inset-0 bg-black/40 z-50 flex items-end justify-center">
                <div className="bg-white w-full rounded-t-2xl max-h-[70%] flex flex-col animate-slide-up">
                  <div className="flex items-center justify-between px-4 py-3 border-b">
                    <h3 className="font-bold text-gray-900">ì°¨ë‹¨ ê´€ë¦¬</h3>
                    <button onClick={() => setShowBlocked(false)} className="text-gray-400 hover:text-gray-600">
                      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                  <div className="flex-1 overflow-y-auto p-4">
                    {loadingBlocked ? (
                      <div className="flex justify-center py-8">
                        <div className="w-8 h-8 border-3 border-pink-main border-t-transparent rounded-full animate-spin" />
                      </div>
                    ) : blockedUsers.length === 0 ? (
                      <div className="text-center py-8 text-gray-400 text-sm">
                        ì°¨ë‹¨ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.
                      </div>
                    ) : (
                      <div className="space-y-2">
                        {blockedUsers.map(u => (
                          <div key={u.id} className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                            <Avatar src={u.profile_image} name={u.nickname} size="md" />
                            <div className="flex-1 min-w-0">
                              <p className="font-semibold text-sm text-gray-900 truncate">{u.nickname}</p>
                              <p className="text-xs text-gray-400 truncate">{u.email}</p>
                            </div>
                            <button
                              onClick={() => handleUnblock(u.id)}
                              className="px-3 py-1.5 text-xs font-semibold text-pink-main bg-pink-50 rounded-lg hover:bg-pink-100 transition-colors"
                            >
                              í•´ì œ
                            </button>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {showThemePicker && (
              <div className="absolute inset-0 bg-black/40 z-50 flex items-end justify-center" onClick={() => setShowThemePicker(false)}>
                <div className="bg-white w-full rounded-t-2xl flex flex-col sheet-up" onClick={e => e.stopPropagation()}>
                  <div className="flex items-center justify-between px-4 py-3.5 border-b border-gray-100">
                    <h3 className="font-bold text-gray-900 text-base">í…Œë§ˆ ë³€ê²½</h3>
                    <button onClick={() => setShowThemePicker(false)} className="text-gray-400 hover:text-gray-600 p-1">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                  <div className="p-5 pb-8">
                    <div className="grid grid-cols-3 gap-3">
                      {THEMES.map(theme => {
                        const isActive = currentTheme === theme.id;
                        return (
                          <button
                            key={theme.id}
                            onClick={() => handleThemeChange(theme.id)}
                            className={`flex flex-col items-center gap-2 p-3 rounded-2xl border-2 transition-all ${
                              isActive ? 'border-gray-900 bg-gray-50' : 'border-transparent hover:bg-gray-50'
                            }`}
                          >
                            <div
                              className="w-12 h-12 rounded-full shadow-md flex items-center justify-center text-xl"
                              style={{
                                background: `linear-gradient(135deg, ${theme.main}, ${theme.dark})`
                              }}
                            >
                              {theme.emoji}
                            </div>
                            <span className="text-xs font-medium text-gray-700">{theme.label}</span>
                            {isActive && (
                              <div className="w-5 h-5 rounded-full flex items-center justify-center" style={{ background: theme.main }}>
                                <svg className="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                </svg>
                              </div>
                            )}
                          </button>
                        );
                      })}
                    </div>
                    <p className="text-center text-xs text-gray-400 mt-4">ì±„íŒ… ë§í’ì„ ê³¼ UI ìƒ‰ìƒì´ ë³€ê²½ë©ë‹ˆë‹¤</p>
                  </div>
                </div>
              </div>
            )}

            {showPhotoPreview && user?.profile_image && (
              <div
                className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center"
                onClick={() => setShowPhotoPreview(false)}
              >
                <button
                  onClick={() => setShowPhotoPreview(false)}
                  className="absolute top-4 right-4 w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
                <img
                  src={user.profile_image}
                  alt={user.nickname}
                  className="max-w-[90vw] max-h-[80vh] rounded-2xl object-contain shadow-2xl"
                  onClick={(e) => e.stopPropagation()}
                />
              </div>
            )}
          </div>
        </AppShell>
      );
    }

    // ========================================
    // ì•± ì»´í¬ë„ŒíŠ¸
    // ========================================
    function AppContent() {
      const { user, loading } = useApp();
      const { path, navigate } = useRouter();

      // í˜„ì¬ íƒ­ ì¸ë±ìŠ¤ (ìŠ¤ì™€ì´í”„ ë„¤ë¹„ê²Œì´ì…˜ìš©)
      const currentPath = path === '' ? 'friends' : path;
      const currentTabIndex = TAB_ORDER.indexOf(currentPath);
      const isMainTab = currentTabIndex !== -1;

      // ìŠ¤ì™€ì´í”„ë¡œ ë‹¤ìŒ/ì´ì „ íƒ­ ì´ë™
      const goNextTab = useCallback(() => {
        if (currentTabIndex >= 0 && currentTabIndex < TAB_ORDER.length - 1) {
          navigate(TAB_ORDER[currentTabIndex + 1]);
        }
      }, [currentTabIndex, navigate]);

      const goPrevTab = useCallback(() => {
        if (currentTabIndex > 0) {
          navigate(TAB_ORDER[currentTabIndex - 1]);
        }
      }, [currentTabIndex, navigate]);

      const { handleTouchStart, handleTouchMove, handleTouchEnd } = useSwipe(goNextTab, goPrevTab);

      // ì¸ì¦ ë¦¬ë‹¤ì´ë ‰íŠ¸
      useEffect(() => {
        if (!loading && !user) {
          if (path !== 'login' && path !== 'register') {
            navigate('login');
          }
        }
      }, [loading, user, path, navigate]);

      // ë¡œê·¸ì¸ í›„ ê¸°ë³¸ í˜ì´ì§€
      useEffect(() => {
        if (!loading && user) {
          if (path === 'login' || path === 'register' || path === '') {
            navigate('friends');
          }
        }
      }, [loading, user, path, navigate]);

      if (loading) {
        return (
          <div className="flex items-center justify-center h-screen bg-white">
            <div className="text-center">
              <div className="w-16 h-16 bg-pink-main rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-pink-main/30">
                <svg className="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
                </svg>
              </div>
              <Spinner className="mb-3" />
              <p className="text-gray-400 text-sm">ë¡œë”© ì¤‘...</p>
            </div>
          </div>
        );
      }

      // ë¼ìš°íŒ…
      // ì±„íŒ…ë°©ì€ chat/:roomId íŒ¨í„´
      const chatMatch = matchRoute('chat/:roomId', path);

      if (path === 'login') return <LoginPage />;
      if (path === 'register') return <RegisterPage />;

      // ë¡œê·¸ì¸ í•„ìš”í•œ í˜ì´ì§€
      if (!user) return null;

      // ì±„íŒ…ë°©ì€ ìŠ¤ì™€ì´í”„ ë¯¸ì ìš©
      if (chatMatch) return <ChatRoomPage roomId={chatMatch.roomId} />;

      // ë©”ì¸ íƒ­ í˜ì´ì§€ë“¤ (ìŠ¤ì™€ì´í”„ ì ìš©)
      let page;
      if (path === 'friends' || path === '') page = <FriendsPage />;
      else if (path === 'chats') page = <ChatsPage />;
      else if (path === 'settings') page = <SettingsPage />;
      else page = <FriendsPage />;

      return (
        <div
          onTouchStart={handleTouchStart}
          onTouchMove={handleTouchMove}
          onTouchEnd={handleTouchEnd}
          className="h-full"
        >
          {page}
        </div>
      );
    }

    function App() {
      return (
        <div className="max-w-[420px] mx-auto h-screen bg-white shadow-2xl shadow-gray-300/50 relative overflow-hidden">
          <AppProvider>
            <Router>
              <AppContent />
              <ToastContainer />
            </Router>
          </AppProvider>
        </div>
      );
    }

    // ========================================
    // ë Œë”ë§
    // ========================================
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
